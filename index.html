<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>ç„¡è²³è‰¯å“é›†é»å¡</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root{--y:#EFC050;--g:#9CB071;--p:#F7A8B8;--b:#64B5F6;--bg:#FAFAFA;--txt:#555}
body{font-family:'Noto Sans TC',sans-serif;background:var(--bg);margin:0;padding:20px;color:var(--txt);-webkit-tap-highlight-color:transparent}
.view{display:none;min-height:90vh;flex-direction:column;align-items:center;width:100%;max-width:500px;margin:0 auto}
.view.active{display:flex}
h2{margin:10px 0 5px;letter-spacing:2px;font-size:24px;font-weight:500;text-align:center}
.sub{color:#999;font-size:13px;margin-bottom:30px;letter-spacing:1px;font-weight:300;text-align:center}

/* Input Fields */
input, select{width:100%;padding:15px;border:2px solid #eee;border-radius:25px;font-size:16px;text-align:center;margin-bottom:15px;background:#fff;transition:.3s;box-sizing:border-box;font-family:inherit;-webkit-appearance:none;}
input:focus, select:focus{outline:0;border-color:var(--y);box-shadow:0 0 0 4px rgba(239,192,80,.1)}

/* Textarea Style */
textarea{width:100%;padding:20px;border:2px solid #eee;border-radius:25px;font-size:15px;margin-bottom:15px;background:#fff;font-family:inherit;box-sizing:border-box;resize:none;min-height:350px;line-height:1.7;color:#333;box-shadow:inset 0 2px 5px rgba(0,0,0,0.05);transition:.3s}
textarea:focus{outline:0;border-color:var(--g);box-shadow:0 0 0 4px rgba(156,176,113,.1)}
.note-input{border:2px dashed #ddd;background:#fffdf5;}

/* --- BUTTON STYLES --- */
button{
  width:100%; padding:15px; border:none; border-radius:25px;
  font-size:16px; font-weight:500; cursor:pointer; margin-bottom:15px;
  font-family:inherit; position: relative;
  transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
}
button:hover { transform: translateY(-3px); filter: brightness(1.08); box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
button:active { transform: scale(0.96) translateY(0); filter: brightness(0.92); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

.btn-y{background:var(--y);color:#fff;box-shadow:0 8px 15px -5px rgba(239,192,80,.4)}
.btn-g{background:var(--g);color:#fff;box-shadow:0 8px 15px -5px rgba(156,176,113,.4)}
.btn-p{background:var(--p);color:#fff;box-shadow:0 8px 15px -5px rgba(247,168,184,.4)}
.btn-b{background:var(--b);color:#fff;box-shadow:0 8px 15px -5px rgba(100,181,246,.4)}
.btn-o{background:#fff;border:1px solid #ddd;color:#888; box-shadow: 0 4px 10px rgba(0,0,0,0.05);}
.btn-adm{background:#fff;color:var(--g);border:1px solid var(--g);font-size:14px;padding:12px}
.btn-reg{background:#fff;border:2px solid var(--y);color:var(--y)}
.btn-use{background:var(--y);color:#fff;font-size:14px;padding:8px 20px;border-radius:15px;width:auto;margin:0;box-shadow:0 4px 10px rgba(239,192,80,.3)}

.card{background:#fff;padding:50px 30px;border-radius:30px;box-shadow:0 15px 35px -10px rgba(0,0,0,.08);width:100%;box-sizing:border-box;text-align:center}
.div{margin:25px 0;display:flex;align-items:center;justify-content:center;color:#ccc;font-size:12px}
.div::before,.div::after{content:'';flex:1;border-bottom:1px solid #eee;margin:0 10px}
.link{margin-top:10px;font-size:13px;color:#aaa;text-decoration:underline;cursor:pointer;display:block}
.u-card{background:#fff;width:100%;padding:30px 25px;border-radius:35px;box-shadow:0 20px 40px -10px rgba(0,0,0,.08);position:relative;overflow:hidden;box-sizing:border-box;margin-bottom:20px}
.u-card::before{content:'';position:absolute;top:0;left:0;right:0;height:6px;background:linear-gradient(to right,var(--p),var(--y),var(--g))}
.head{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px}
.grid{display:grid;grid-template-columns:repeat(5,1fr);gap:15px;justify-items:center}
.stp{width:40px;height:40px;border-radius:50%;background:#F5F5F5;display:flex;align-items:center;justify-content:center;font-size:14px;color:#CCC;transition:.3s}
.stp.on{background:var(--p);color:#fff;transform:scale(1.1);box-shadow:0 5px 15px rgba(247,168,184,.4)}
.stp.on.anim{animation:pop .5s ease}@keyframes pop{0%{transform:scale(.5);opacity:0}100%{transform:scale(1.1);opacity:1}}
.wall{background:#FFF8E1;border:2px dashed var(--y);border-radius:20px;padding:15px;margin-top:25px;text-align:center;display:none}
.wall-n{font-size:32px;font-weight:700;color:var(--y);margin:5px 0}

.nav{display:flex;justify-content:space-between;align-items:center;width:100%;margin-bottom:15px}
.dash{display:grid;grid-template-columns:1fr 1fr;gap:10px;width:100%;margin-bottom:20px}
.stat{background:#fff;padding:15px;border-radius:20px;text-align:center;border-bottom:4px solid #eee}
.s-val{font-size:22px;font-weight:500;color:#333}.s-lbl{font-size:11px;color:#999}
.search{display:flex;gap:10px;margin-bottom:20px}.search input{margin:0;flex:1;text-align:left;padding-left:20px}

/* --- ADMIN MEMBER CARD --- */
.m-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:15px;width:100%;padding-bottom:80px}
.mc{
    background:#fff; border-radius:20px; padding:15px; cursor:pointer;
    border:2px solid transparent; position:relative;
    transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
}
.mc:active{ transform:scale(.96); }
.mc:hover {
    transform: translateY(-5px); border-color: var(--g);
    box-shadow: 0 10px 25px -5px rgba(156,176,113,.3); background: #F8FDF5;
}
.mc.has{border-color:var(--p);background:#FFFBFB}
.mc.has:hover { border-color:var(--p); background:#FFF0F5; box-shadow: 0 10px 25px -5px rgba(247,168,184,.4); }

.bar{height:6px;background:#eee;border-radius:3px;margin-top:10px;overflow:hidden}.fill{height:100%;background:var(--g);width:0%;transition:.3s}
.mc.has .fill{background:var(--p)}.c-bad{position:absolute;top:10px;right:10px;font-size:10px;background:var(--p);color:#fff;padding:2px 8px;border-radius:8px;display:none}
.mc.has .c-bad{display:block}.b-bad{position:absolute;top:10px;left:10px;font-size:16px;display:none}
.mc.bday .b-bad{display:block;animation:bnc 1s infinite}@keyframes bnc{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}

.fab{position:fixed;bottom:30px;right:30px;width:55px;height:55px;background:var(--g);color:#fff;border-radius:50%;font-size:28px;display:flex;align-items:center;justify-content:center;box-shadow:0 10px 20px -5px rgba(156,176,113,.5);cursor:pointer;z-index:100}
.ctrl-in{background:#f9f9f9;padding:20px;border-radius:20px;margin-bottom:20px}
.num-d{font-size:48px;font-weight:700;color:var(--g);margin-bottom:10px;line-height:1}
.money-w{display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:15px}
.money-i{width:100px;padding:5px 10px;border:1px solid #ddd;border-radius:10px;font-size:14px;margin:0;text-align:center}
input[type=range]{-webkit-appearance:none;width:100%;background:0 0}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;height:24px;width:24px;border-radius:50%;background:#fff;border:2px solid var(--g);cursor:pointer;margin-top:-10px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
input[type=range]::-webkit-slider-runnable-track{width:100%;height:4px;cursor:pointer;background:#ddd;border-radius:2px}
.acts{display:flex;gap:10px}.btn-add{flex:2;background:var(--g);color:#fff;border-radius:15px;padding:12px;font-size:15px;border:none;box-shadow:0 4px 10px rgba(156,176,113,.3)}
.btn-sub{flex:1;background:#fff;color:#E57373;border:1px solid #E57373;border-radius:15px;padding:12px;font-size:15px}
.btn-bon{background:#FFF3E0;color:#FF9800;font-size:14px;padding:8px 15px;border-radius:20px;border:1px solid #FFE0B2;margin-bottom:10px;cursor:pointer;display:inline-block}.btn-bon.used{background:#EEE;color:#AAA;border-color:#DDD;cursor:default}
.skel{animation:sl 1.5s infinite;color:transparent!important;background:#f0f0f0;border-radius:8px}@keyframes sl{0%,100%{background-color:#f0f0f0}50%{background-color:#e0e0e0}}
.sk-t{width:100%;height:1em;display:inline-block}

.soc-box{width:100%;text-align:center;} 
.soc-tip{background:#FFF8E1;border:2px dashed var(--y);color:#8d6e1f;padding:15px;border-radius:20px;font-size:14px;margin-top:15px;display:flex;align-items:start;gap:10px;text-align:left;line-height:1.5;}
.soc-tip::before{content:'ğŸ’¡';font-size:18px;}
.tog-grp{display:flex;gap:10px;margin-bottom:15px;}
.tog-btn{
    flex:1; padding:12px; border:2px solid #eee; border-radius:25px;
    background:#fff; color:#999; font-size:14px; font-weight:500;
    cursor:pointer; text-align:center;
    transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
}
.tog-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-color:#ddd; }
.tog-btn:active { transform: scale(0.96); }
.tog-btn.act{background:var(--g);color:#fff;border-color:var(--g);box-shadow:0 5px 15px -5px rgba(156,176,113,.5);}
.tog-btn.act:hover { transform: translateY(-2px); filter: brightness(1.05); }

div:where(.swal2-popup){border-radius:30px!important;padding:25px!important;width:85%!important;max-width:360px!important}
div:where(.swal2-actions) button{border-radius:15px!important;flex:1!important;margin:0 5px!important}
#load{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.98);z-index:9999;display:none;justify-content:center;align-items:center;flex-direction:column}
.spin{font-size:40px;display:inline-block;animation:sp 1.2s linear infinite}.spin:nth-child(2){animation-delay:.2s}.spin:nth-child(3){animation-delay:.4s}@keyframes sp{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
</style>
</head>
<body>
  <div id="load">
    <div style="display:flex;gap:10px;"><span class="spin">ğŸ‹</span><span class="spin">ğŸŒ¿</span><span class="spin">ğŸŒ¸</span></div>
    <div style="font-size:12px;color:#aaa;margin-top:15px;letter-spacing:2px;">PROCESSING...</div>
    <button onclick="stopLoad(true)" style="width:auto;margin-top:30px;padding:8px 25px;background:#fff;border:1px solid #ddd;border-radius:20px;color:#999;font-size:13px">âœ• å–æ¶ˆ</button>
  </div>

  <div id="v-home" class="view active">
    <div class="card">
      <h2 style="color:var(--g)">ç„¡è²³è‰¯å“</h2><div class="sub">é›†é»æœƒå“¡ç³»çµ±</div>
      <input type="tel" id="hp" placeholder="è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼" maxlength="10">
      <button class="btn-y" onclick="uLogin()">ç™»å…¥/æŸ¥è©¢é›†é»å¡</button>
      <button class="btn-reg" onclick="reg()">ç«‹å³è¨»å†Šæœƒå“¡</button>
      <div class="link" onclick="rules()">ğŸ“ æŸ¥çœ‹é›†é»è¦å‰‡</div>
      <div class="div">STAFF ONLY</div>
      <button class="btn-adm" onclick="admLogin()">å·¥ä½œå¤¥ä¼´å…¥å£</button>
    </div>
  </div>

  <div id="v-user" class="view">
    <h2 style="margin-top:30px">æˆ‘çš„é›†é»å¡</h2><div class="sub">ç„¡è²³è‰¯å“</div>
    <div class="u-card">
      <div class="head">
        <div style="font-size:18px;font-weight:500">æœƒå“¡å¡</div>
        <div style="background:#f5f5f5;color:#999;padding:4px 12px;border-radius:15px;font-size:12px" id="un"></div>
      </div>
      <div class="grid" id="ug"></div>
      <div id="ufull" style="text-align:center;margin-top:20px;display:none">
        <div style="color:var(--p);font-weight:500;font-size:16px;margin-bottom:5px">ğŸ‰ å·²é›†æ»¿ 10 é»ï¼</div>
        <div style="color:var(--y);font-weight:700;font-size:18px;letter-spacing:1px;border:2px dashed var(--y);padding:10px;border-radius:15px;background:#fffdf5">ç²å¾— 9 æŠ˜å…Œæ›åˆ¸</div>
      </div>
      <div id="uwall" class="wall">
        <div style="font-size:13px;color:#888">âœ¨ å¯ç”¨å„ªæƒ åˆ¸ (å¯ç´¯ç©)</div>
        <div class="wall-n"><span id="ucnt">0</span> å¼µ</div>
        <button class="btn-use" onclick="uRedeem()">ç«‹å³å…Œæ›æŠ˜æ‰£</button>
      </div>

      <div style="text-align:center;margin-top:15px;margin-bottom:10px;color:#999;font-size:13px">
        ç´¯è¨ˆå·²å…Œæ› <span id="ur" style="color:var(--y);font-weight:700">0</span> å¼µ
      </div>
    </div>

    <button class="btn-o" onclick="hist(STATE.curr)">ğŸ“œ æŸ¥çœ‹æ­·å²ç´€éŒ„</button>

    <div class="link" onclick="rules()" style="text-align:center;margin-bottom:20px">ğŸ“ æŸ¥çœ‹é›†é»è¦å‰‡</div>
    <button class="btn-o" onclick="route('v-home')">â†º è¿”å›æŸ¥è©¢</button>
  </div>

  <div id="v-adm" class="view">
    <div class="nav">
      <div style="font-weight:500;display:flex;align-items:center;gap:5px">ç„¡è²³å¾Œå° <span id="sn" style="font-size:12px;background:#E8F5E9;color:#4CAF50;padding:2px 8px;border-radius:10px">Guest</span></div>
      <button class="btn-o" style="width:auto;margin:0;padding:5px 15px;font-size:12px;border-radius:15px" onclick="logout()">ç™»å‡º</button>
    </div>
    
    <button class="btn-b" onclick="route('v-social');socInit();" style="display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 8px 20px -5px rgba(100,181,246,.4)">
        <span>âœï¸ ç¤¾ç¾¤è²¼æ–‡åŠ©æ‰‹</span>
    </button>

    <div class="dash">
      <div class="stat" style="border-color:var(--p)"><div class="s-lbl">å„ªæƒ åˆ¸å·²å…Œæ›</div><div class="s-val" id="ar">0</div></div>
      <div class="stat" style="border-color:var(--y)"><div class="s-lbl">æœƒå“¡ç¸½æ•¸</div><div class="s-val" id="am">0</div></div>
    </div>
    <div class="search"><input type="text" id="as" placeholder="ğŸ” æœå°‹..." onkeyup="filter()"></div>
    <div class="m-grid" id="ag"></div>
    <div class="fab" onclick="reg()">ï¼‹</div>
  </div>

  <div id="v-social" class="view">
    <div class="card" style="padding-top:30px;">
        <div class="nav">
            <div style="font-weight:500;font-size:18px;">ç¤¾ç¾¤è²¼æ–‡åŠ©æ‰‹</div>
            <button class="btn-o" style="width:auto;margin:0;padding:6px 15px;font-size:12px;border-radius:15px" onclick="route('v-adm')">âœ• é—œé–‰</button>
        </div>

        <div class="soc-box">
            <div style="font-size:13px;color:#999;margin-bottom:10px;text-align:left;">ä»Šå¤©æƒ³ç™¼ä»€éº¼ä¸»é¡Œçš„æ–‡ï¼Ÿ</div>
            <select id="soc-mode" onchange="socRender()" style="text-align-last:center;"> 
                <option value="new">ğŸ“¦ è¿‘æœŸä¸Šæ¶ (æ–°ç‰©è³‡)</option>
                <option value="staff">â¤ï¸ è‡ªå·±äººä¹Ÿè²· (å“¡å·¥æ¨)</option>
                <option value="story">ğŸ˜Š æ•…äº‹å›é¥‹ (é¡§å®¢)</option>
            </select>

            <div id="soc-inputs" style="margin-bottom:20px;"></div>
            <input id="si-custom" class="note-input" placeholder="âœï¸ å…¶ä»–è£œå…… (é¸å¡«ï¼Œä¾‹å¦‚: é€±äº”ç‰¹åƒ¹ã€éœ€è‡ªå–...)">
            <div id="soc-tip" class="soc-tip" style="display:none;"></div>
            <div class="div" style="margin:25px 0;">ç”¢ç”Ÿçµæœ</div>
            <textarea id="soc-res" readonly placeholder="é»æ“Šä¸‹æ–¹æŒ‰éˆ•ç”¢ç”Ÿæ–‡æ¡ˆ..."></textarea>
            <div style="display:flex;gap:10px;">
                <button class="btn-g" onclick="socGen()" style="flex:1.5;">âœ¨ éš¨æ©Ÿç”¢ç”Ÿè²¼æ–‡</button>
                <button class="btn-o" onclick="socCopy()" style="flex:1;">ğŸ“‹ è¤‡è£½</button>
            </div>
        </div>
    </div>
  </div>

<script>
// â˜…â˜…â˜… GAS API URL â˜…â˜…â˜…
const API_URL = "https://script.google.com/macros/s/AKfycbwsfPMn54aqd3u-4SHkGmdfS-drw8MLNE-3lVq1XP-pCPSOW1ZxwDvTnd-85uQpuuc/exec";

const $ = s => document.querySelector(s);
const STATE = { pass: '', staff: '', mems: [], curr: '', timer: null };
const AUD = { s: new Audio('https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg'), r: new Audio('https://actions.google.com/sounds/v1/science_fiction/scifi_laser.ogg'), e: new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg') };
const play = t => { try{ let a=AUD[t]; a.currentTime=0; a.play(); }catch(e){} };
const toast = (ic, ti) => Swal.fire({toast:true,position:'top',icon:ic,title:ti,showConfirmButton:false,timer:1500});

async function api(act, p={}) {
  try { return await (await fetch(API_URL, {method:"POST", body:JSON.stringify({action:act, params:p})})).json(); }
  catch(e) { return {success:false, msg:"é€£ç·šéŒ¯èª¤"}; }
}

let loadT = null;
const msgs = ["è³‡æ–™è®€å–ä¸­...","è²“å’ªæŠŠæ°´æ‰“ç¿»äº†ï¼Ÿ...","ä½ çŸ¥é“ç‚ºä»€éº¼å¤©ç©ºæ˜¯ç¶ è‰²çš„å—...","æ›¾ä»¥ç‚ºè¬é›£æ‡‚çš„æˆ‘...","è²“å’ªè‚šå­é¤“..."];
function load(s=true) {
  $('#load').style.display = s ? 'flex' : 'none';
  if(s) { let i=0; if(loadT) clearInterval(loadT); loadT=setInterval(()=>{$('#load div:nth-child(2)').innerText=msgs[i++%3]}, 1500); }
  else if(loadT) clearInterval(loadT);
}
function stopLoad(force) { if(STATE.timer) clearInterval(STATE.timer); if(force){ STATE.pass=""; load(false); route('v-home'); } }

function route(id) { document.querySelectorAll('.view').forEach(e=>e.classList.remove('active')); $(`#${id}`).classList.add('active'); window.scrollTo(0,0); }

function rules() { Swal.fire({title:'è¦å‰‡èªªæ˜',html:`<div style="text-align:left;font-size:14px;color:#555">1. æ¶ˆè²» $100 é›† 1 é»<br>2. é›†æ»¿ 10 é»æ› 9 æŠ˜åˆ¸<br>3. é¦–æ¬¡æ¶ˆè²»è´ˆ 5 é»</div>`,confirmButtonColor:'#EFC050'}); }

// === SOCIAL TOOL LOGIC START ===
const SOC_DATA = {
    new: {
        tips: "æ•æ‰ç‰©è³‡çš„ã€Œæ“¬äººè¡¨æƒ…ã€ã€‚è©¦è‘—è¹²ä¸‹èˆ‡å®ƒå€‘å¹³è¦–æ‹æ”ï¼Œæœƒæ›´æœ‰æ•…äº‹æ„Ÿã€‚",
        title: ["ã€ğŸ§¸ æœ¬é€±æ–°ç‰©ï½œç™‚ç™’ç³»çš„æº«æŸ”é‚‚é€…ã€‘", "ã€âœ¨ å‰›å‰›å¥½ï¼Œä½ ä¹Ÿåœ¨ç­‰ä¸€å€‹æŠ±æŠ±å—ï¼Ÿã€‘", "ã€ğŸ“¦ è½‰èº«ä¹‹å¾Œï¼Œçœ‹è¦‹ç‰©ä»¶çš„æ–°ç”Ÿå‘½ã€‘"], 
        observations: [
            "ä»Šå¤©æ•´ç†ç‰©è³‡æ™‚ï¼Œå·¥ä½œå®¤è£¡çªç„¶å®‰éœäº†ä¸€ä¸‹ï¼Œå¤§å®¶éƒ½çœ‹è‘—é€™æ‰¹å‰›é€ä¾†çš„å¤¥ä¼´å‡ºç¥ã€‚",
            "å·¥ä½œå®¤è£¡å‚³ä¾†é™£é™£ç¬‘è²ï¼ŒåŸä¾†æ˜¯é€™é€±å‰›æ•´ç†å¥½çš„æˆå“¡ï¼Œè¡¨æƒ…å¯¦åœ¨å¤ªæœ‰æˆ²äº†ã€‚",
            "æ¯ä¸€ä»¶ä¾†åˆ°é€™è£¡çš„ç‰©è³‡ï¼Œéƒ½å¸¶è‘—ä¸€æ®µæ•…äº‹ï¼Œæ­£éœéœç­‰å¾…è‘—ä¸‹ä¸€å€‹æ‡‚å®ƒçš„äººã€‚"
        ],
        personified: [
            "æœ‰çš„çœ‹èµ·ä¾†æ­£ä¹–ä¹–åå¥½ï¼Œæœ‰çš„å‰‡æ˜¯ä¸€è‡‰ã€Œæˆ‘ä»Šå¤©ä¸æƒ³ä¸Šç­ã€çš„æ…µæ‡¶æ„Ÿã€‚",
            "å®ƒå€‘ä¸åªæ˜¯ç‰©å“ï¼Œæ›´åƒæ˜¯å¸¶è‘—æº«åº¦çš„é™ªä¼´ï¼Œåœ¨è§’è½æ•£ç™¼è‘—å…‰ã€‚",
            "åƒæ˜¯ä¸€ç¾¤å‰›æ¸¸å®Œä¸€åœˆäººç”Ÿçš„å¤¥ä¼´ï¼Œæ­£æº–å‚™åœ¨é€™è£¡é–‹å•Ÿä¸‹ä¸€æ®µæ—…ç¨‹ã€‚"
        ],
        mission: [
            "åœ¨ç„¡è²³è‰¯å“ï¼Œé€™äº›ç‰©ä»¶ç”±èº«éšœé’å¹´å€‘ç´°å¿ƒåˆ†é¡ã€æ¸…æ´—ã€æ•´ç†ï¼Œè¢«æº«æŸ”åœ°é‡æ–°å°å¾…ã€‚",
            "é€™äº›å­©å­ç”¨æ…¢æ…¢çš„é€Ÿåº¦ï¼ŒæŠŠæ¯ä¸€ä»¶ç‰©è³‡æ“¦æ‹­å¾—é–ƒé–ƒç™¼å…‰ï¼Œé‚£æ˜¯å°ç”Ÿæ´»æœ€ç´”ç²¹çš„åŠªåŠ›ã€‚",
            "é€éé€™ç¾¤åŠªåŠ›å·¥ä½œçš„å­©å­ä¹‹æ‰‹ï¼ŒèˆŠç‰©ä¸å†æ˜¯å»¢æ£„ç‰©ï¼Œè€Œæ˜¯è¢«å¥½å¥½æ¥ä½çš„æ„›ã€‚"
        ],
        closings: [
            "å–œæ­¡å°±è¦å¿«å”·ï¼Œå› ç‚ºé€™äº›è¿·äººçš„è¡¨æƒ…ï¼ŒçœŸçš„å¾ˆé›£ä¸è¢«ä¸€çœ¼æŠ±èµ° ğŸ¤",
            "ä¸ç”¨èŠ±å¤§éŒ¢ï¼Œä¹Ÿèƒ½æŠŠé€™ä»½æº«æŸ”å¸¶å›å®¶ï¼›è®“å…¬ç›Šï¼Œåœ¨æ—¥å¸¸æ¶ˆè²»ä¸­æº«æš–å»¶çºŒã€‚",
            "æˆ‘å€‘åœ¨é€™è£¡ï¼Œç­‰å¾…é€™ä»½æº«æŸ”è¢«ä½ æ¥ä½ã€‚æ˜å¤©åº—è£¡è¦‹å§ï¼Ÿ"
        ]
    },
    staff: {
        tips: "æ‹ä¸‹å¤¥ä¼´ã€Œä½é ­æ•´ç†ã€æˆ–ã€ŒæŒ‡å°–è§¸æ‘¸ç‰©ä»¶ç´°ç¯€ã€çš„ç¬é–“ï¼Œå¼·èª¿çœŸå¯¦æ„Ÿã€‚",
        title: ["ã€ğŸ¤« åº—å“¡ç§å¿ƒæ¨æ¨ï½œä¸æƒ³æ”¾æ‰‹çš„ç†ç”±ã€‘", "ã€â¤ï¸ è—åœ¨å¿ƒåº•çš„å¯¶è—ï¼Œæƒ³åˆ†äº«çµ¦ä½ ã€‘"],
        intros: [
            "èªªçœŸçš„ï¼Œæœ‰æ™‚å€™æˆ‘å€‘çœŸçš„æœƒç”Ÿå‡ºä¸€ç¨®ã€Œä¸æƒ³è®“å®ƒé›¢é–‹ã€çš„ç§å¿ƒ...",
            "åœ¨å­©å­å€‘ç´°å¿ƒæ•´ç†çš„éç¨‹ä¸­ï¼Œæˆ‘å€‘çœ‹è¦‹äº†é€™ä»¶ç‰©å“æœ€ç¾çš„æ¨£å­ï¼Œå¿ƒè£¡çœŸçš„å¥½æ¨ä¸å¾—ã€‚",
            "æœ‰äº›å¥½ç‰©ï¼ŒçœŸçš„éœ€è¦å¾ˆå¼·çš„ç†æ™ºï¼Œæ‰èƒ½å¿ä½ä¸æŠŠè‡ªå·±å·å·æ”¶ç·¨å›å®¶ã€‚"
        ],
        struggles: [
            "çœ‹è‘—å®ƒè¢«æ“¦æ‹­å¾—äº®æ™¶æ™¶ï¼Œåƒé‡ç²æ–°ç”Ÿä¸€æ¨£ï¼Œå¿ƒè£¡çœŸçš„å¾ˆæœ‰æˆå°±æ„Ÿã€‚",
            "é›–ç„¶ç†æ™ºå‘Šè¨´æˆ‘å€‘è¦è®“æ„›å¾ªç’°ï¼Œä½†é€™ä»½è³ªæ„Ÿï¼ŒçœŸçš„è®“äººæƒ³å¤šåœç•™ä¸€æœƒå…’ã€‚",
            "æ•´ç†å®ƒçš„éç¨‹å¾ˆæ…¢ã€å¾ˆæ…¢ï¼Œä½†çœ‹è¦‹å®ƒå†æ¬¡ç™¼å…‰çš„æ¨¡æ¨£ï¼Œä¸€åˆ‡éƒ½å€¼å¾—äº†ã€‚"
        ],
        closings: [
            "è¶æˆ‘é‚„æ²’å¾Œæ‚”ä¸‹æ¶å‰ï¼Œè­˜è²¨çš„ä½ ï¼Œå¿«ä¾†åº—è£¡å¸¶èµ°é€™ä»½ç¾å¥½å§ï¼ğŸƒâ€â™‚ï¸",
            "é€™ä¸åªæ˜¯ä¸€æ¬¡æ¶ˆè²»ï¼Œæ›´æ˜¯å°é€™ç¾¤åŠªåŠ›å·¥ä½œçš„å­©å­å€‘ï¼Œæœ€å¯¦è³ªçš„è‚¯å®šã€‚",
            "è®“é€™ä»½å¥½ç‰©å»åˆ°æ›´é©åˆçš„åœ°æ–¹ï¼Œæˆ‘å€‘æ±ºå®šå¿ç—›å‰²æ„›å›‰ï¼"
        ]
    },
    story: {
        tips_y: "æ•æ‰å®¢äººã€ŒæŠ±ä½ç‰©å“ã€æˆ–ã€ŒæŒ‡å°–ç›¸è§¸ã€çš„æº«åº¦ã€‚å´è‡‰æˆ–èƒŒå½±æœ‰æ™‚æ¯”æ­£è‡‰æ›´å‹•äººã€‚",
        tips_n: "æ‹ä¸‹ç‰©å“è¢«åŒ…è£å¥½ã€æº–å‚™é›¢é–‹çš„èƒŒå½±ï¼Œè±¡å¾µå®ƒå³å°‡å±•é–‹æ–°çš„ç”Ÿå‘½æ—…ç¨‹ã€‚",
        title: ["ã€ğŸ¥° æš–å¿ƒå›é¥‹æ—¥å¸¸ï½œæŠŠæ„›å¥½å¥½æ¥ä½ã€‘", "ã€âœ¨ è¬è¬ä½ ï¼Œçµ¦äº†å®ƒç¬¬äºŒæ¬¡ç”Ÿå‘½ã€‘"],
        openers: [
            "æœ€å‹•äººçš„ç¬é–“ï¼Œè«éæ–¼çœ‹åˆ°é€™äº›è¢«æº«æŸ”å°å¾…çš„ç‰©å“ï¼Œé‡æ–°åœ¨å¦ä¸€å€‹äººæ‰‹ä¸­ç™¼å…‰ã€‚",
            "åœ¨ç„¡è²³è‰¯å“ï¼Œæˆ‘å€‘æ•´ç†çš„ä¸åªæ˜¯ç‰©è³‡ï¼Œæ›´æ˜¯ä¸€ä»½ä»½æƒ³å‚³éå‡ºå»çš„æº«åº¦ã€‚",
            "çœ‹è‘—å®¢äººå¸¶è‘—æ»¿æ„çš„ç¬‘å®¹é›¢é–‹ï¼Œæˆ‘å€‘çŸ¥é“ï¼Œé€™ä»½ä½¿å‘½åˆå®Œæˆäº†ä¸€æ¬¡ç¾å¥½çš„æ¥åŠ›ã€‚"
        ],
        connectors: [
            "è½è‘—å®¢äººåˆ†äº«é€™ä»¶å¥½ç‰©æœªä¾†çš„æ–°å®¶ï¼Œå¿ƒè£¡çªç„¶è¦ºå¾—æš–çƒ˜çƒ˜çš„ã€‚",
            "ç•¶ä¸‹çœŸçš„æ·±åˆ»æ„Ÿå—åˆ°ï¼Œé€™å°±æ˜¯æˆ‘å€‘ç¶“ç‡Ÿé€™é–“åº—æœ€é‡è¦çš„æ„ç¾©ã€‚",
            "èƒ½å¤ å¹«å®ƒæ‰¾åˆ°é€™éº¼æ£’çš„æ–°ä¸»äººï¼ŒçœŸçš„æ˜¯å°é€™ç¾¤å­©å­æœ€å¤§çš„é¼“å‹µèˆ‡è‚¯å®šï¼"
        ]
    }
};

let soc_state = { hasPhoto: true, hasFeedback: true };

function socInit() {
    $('#soc-res').value = '';
    $('#si-custom').value = '';
    socRender();
}

function socRender() {
    const mode = $('#soc-mode').value;
    const con = $('#soc-inputs');
    let html = '';

    if(mode === 'new') {
        html = `<input id="si-1" placeholder="å•†å“åç¨± (ä¾‹: å¾©å¤é¦¬å…‹æ¯)">
                <input id="si-2" placeholder="ç‰¹è‰²/æ°›åœ (ä¾‹: è¾¦å…¬å®¤ä¸‹åˆèŒ¶å¿…å‚™)">`;
        $('#soc-tip').innerText = SOC_DATA.new.tips;
    } else if(mode === 'staff') {
        html = `<input id="si-1" placeholder="å•†å“åç¨± (ä¾‹: å…¨æ–°å¸†å¸ƒåŒ…)">
                <input id="si-2" placeholder="ç§å¿ƒæ¨è–¦ç†ç”± (ä¾‹: æè³ªè¶…åšå¯¦)">`;
        $('#soc-tip').innerText = SOC_DATA.staff.tips;
    } else {
        html = `<div style="font-size:13px;color:#999;margin-bottom:10px;text-align:left;">è«‹é¸æ“‡æƒ…å¢ƒï¼š</div>
                <div class="tog-grp">
                   <div class="tog-btn ${soc_state.hasPhoto?'act':''}" onclick="socTog('hasPhoto',true)">ğŸ“¸ æœ‰æ‹åˆç…§</div>
                   <div class="tog-btn ${!soc_state.hasPhoto?'act':''}" onclick="socTog('hasPhoto',false)">ğŸ“¦ åƒ…æ‹å•†å“</div>
                </div>
                <div class="tog-grp" style="margin-bottom:20px">
                   <div class="tog-btn ${soc_state.hasFeedback?'act':''}" onclick="socTog('hasFeedback',true)">ğŸ’¬ æœ‰æ„Ÿæƒ³</div>
                   <div class="tog-btn ${!soc_state.hasFeedback?'act':''}" onclick="socTog('hasFeedback',false)">ğŸ˜¶ ç„¡æ„Ÿæƒ³</div>
                </div>
                <input id="si-1" placeholder="å”®å‡ºå•†å“åç¨± (ä¾‹: å¾©å¤æª¯ç‡ˆ)">
                ${soc_state.hasFeedback ? '<input id="si-2" placeholder="å®¢äººèªªäº†ä»€éº¼? (ç°¡çŸ­)">' : ''}`;
        $('#soc-tip').innerText = soc_state.hasPhoto ? SOC_DATA.story.tips_y : SOC_DATA.story.tips_n;
    }
    con.innerHTML = html;
    $('#soc-tip').style.display = 'flex';
}

function socTog(k, v) { soc_state[k]=v; socRender(); }
const rnd = arr => arr[Math.floor(Math.random() * arr.length)];

function socGen() {
    const mode = $('#soc-mode').value;
    const v1 = $('#si-1').value || "[å•†å“]";
    const v2 = $('#si-2') ? $('#si-2').value : "";
    const extra = $('#si-custom').value.trim();
    const data = SOC_DATA[mode];
    let txt = "";

    // éš¨æ©Ÿé¸æ¨™é¡Œ
    txt += `${rnd(data.title)}\n\n`;

    if(mode === 'new') {
        txt += `${rnd(data.observations)}\n\n`;
        txt += `é€™æ¬¡çš„ä¸»è§’æ˜¯ ğŸ‘‰ ${v1}\n`;
        txt += `${v2 ? `å®ƒå¸¶çµ¦æˆ‘å€‘ä¸€ç¨®ã€Œ${v2}ã€çš„æ„Ÿè¦ºã€‚\n` : ""}`;
        txt += `${rnd(data.personified)}\n\n`;
        txt += `â”€â”€â”€\n\n`;
        txt += `${rnd(data.mission)}\n\n`;
        txt += `${extra ? `ğŸ’¡ å°ç·¨æƒ³è£œå……ï¼š${extra}\n\n` : ""}`;
        txt += `${rnd(data.closings)}`;
    } else if (mode === 'staff') {
        txt += `${rnd(data.intros)}\n\n`;
        txt += `é€™æ¬¾ã€Œ${v1}ã€ä¹‹æ‰€ä»¥ç‰¹åˆ¥ï¼Œæ˜¯å› ç‚ºå®ƒ${v2 ? v2 : "è³ªæ„Ÿå¤ªå¥½"}ï¼Œ\n`;
        txt += `${rnd(data.struggles)}\n\n`;
        txt += `åœ¨ç„¡è²³ï¼Œæ¯ä¸€ä»¶ç‰©å“éƒ½ç¶“éèº«éšœé’å¹´å€‘ç·©æ…¢è€Œç”¨å¿ƒçš„å°å¾…ã€‚\n`;
        if(extra) txt += `ğŸ’¡ æ‚„æ‚„è©±ï¼š${extra}\n\n`;
        txt += `${rnd(data.closings)}`;
    } else {
        txt += `${rnd(data.openers)}\n\n`;
        txt += `ä»Šå¤©ï¼Œé€™ä½å¯æ„›çš„å¤¥ä¼´ã€Œ${v1}ã€æ‰¾åˆ°æ–°ä¸»äººå›‰ï¼ğŸ \n\n`;
        if(soc_state.hasFeedback) {
            txt += `å®¢äººå‘Šè¨´æˆ‘å€‘ï¼šã€Œ${v2 || "çœŸçš„å¾ˆå–œæ­¡"}ã€\n`;
            txt += `${rnd(data.connectors)}\n\n`;
        }
        if(extra) txt += `ğŸ’¡ è£œå……ï¼š${extra}\n\n`;
        txt += soc_state.hasPhoto ? "ï¼ˆç…§ç‰‡å·²ç²æˆæ¬Šï¼Œè¬è¬å®¢äººçš„æº«æš–åˆ†äº«ğŸ¥°ï¼‰" : "ï¼ˆé›–ç„¶å®¢äººå®³ç¾æ²’å…¥é¡ï¼Œä½†é€™ä»½å¿ƒæ„æˆ‘å€‘æ”¶åˆ°äº†ï¼ï¼‰";
        txt += `\nè¬è¬ä½ å€‘ï¼Œè®“äºŒæ‰‹çš„æµªæ¼«ç¹¼çºŒå¯«ä¸‹å»ã€‚`;
    }
    
    txt += `\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nç”¨æ—¥å¸¸æ¶ˆè²»åšå…¬ç›Šï¼Œ\nä¸€èµ·è²·å¥½ç‰©ï¼Œä¹Ÿåšå¥½äº‹ã€‚\n\nğŸ“ åœ°å€ï¼š950 è‡ºæ±ç¸£è‡ºæ±å¸‚å¸‚æ°‘èˆªè·¯ 793 è™Ÿ\nğŸ·ï¸ #ç„¡è²³è‰¯å“ #å…¬ç›ŠäºŒæ‰‹ #å°æ±æ¢åº— #èº«éšœå°±æ¥­`; 
    
    $('#soc-res').value = txt;
}

function socCopy() {
    const t = $('#soc-res');
    if(!t.value) return toast('warning', 'è«‹å…ˆç”¢ç”Ÿæ–‡æ¡ˆ');
    t.select();
    document.execCommand('copy');
    toast('success', 'å·²è¤‡è£½æ–‡æ¡ˆï¼');
}
// === SOCIAL TOOL LOGIC END ===

// User Logic
async function uLogin() {
  const p = $('#hp').value.trim();
  if(!p) return Swal.fire('è«‹è¼¸å…¥æ‰‹æ©Ÿ');
  STATE.curr = p; route('v-user');
  $('#un').innerHTML = '<span class="skel sk-t" style="width:80px"></span>';
  $('#ug').innerHTML = Array(10).fill('<div class="stp skel"></div>').join('');
  
  load(); const r = await api('getMemberData', {phone:p}); load(false);
  if(r.success) {
    if(r.isBirthdayToday) { confetti({origin:{y:.7}}); Swal.fire({title:'ğŸ‚ ç”Ÿæ—¥å¿«æ¨‚ï¼',icon:'success',timer:2000,showConfirmButton:false}); }
    renderU(r.name, r.current, r.redeemed);
  } else {
    Swal.fire({icon:'error',title:'æŸ¥ç„¡æœƒå“¡',confirmButtonText:'å»è¨»å†Š',confirmButtonColor:'#EFC050'}).then(res=>{if(res.isConfirmed)reg(); else route('v-home')});
  }
}

function renderU(n, cur, red) {
  $('#un').innerText = n; $('#ur').innerText = red; $('#ucnt').innerText = Math.floor(cur/10);
  const prog = cur % 10;
  $('#ug').innerHTML = Array.from({length:10},(_,i)=>`<div class="stp ${i<prog?'on anim':''}" style="animation-delay:${(i+1)*.05}s">${i+1}</div>`).join('');
  $('#ufull').style.display = prog>=10?'block':'none';
  $('#uwall').style.display = Math.floor(cur/10)>0?'block':'none';
}

async function uRedeem() {
  const {value:pass} = await Swal.fire({title:'åº—å“¡ç¢ºèª',text:'è«‹è¼¸å…¥åº—å“¡å¯†ç¢¼',input:'password',showCancelButton:true,confirmButtonColor:'#9CB071'});
  if(pass) {
    load(); const r = await api('redeemCard', {password:pass, phone:STATE.curr}); load(false);
    if(r.success) { play('r'); Swal.fire('å…Œæ›æˆåŠŸ','','success'); renderU($('#un').innerText, r.current, r.redeemed); }
    else { play('e'); Swal.fire('å¤±æ•—', r.msg, 'error'); }
  }
}

// Admin Logic
async function admLogin() {
  const {value:pass} = await Swal.fire({title:'å¾Œå°ç™»å…¥',input:'password',confirmButtonColor:'#9CB071'});
  if(pass) {
    STATE.pass = pass; route('v-adm');
    $('#ag').innerHTML = Array(6).fill('<div class="mc skel" style="height:100px"></div>').join('');
    load(); const r = await api('adminLoginAndGetData',{password:pass}); load(false);
    if(r.success) {
      sessionStorage.setItem('SP', pass); STATE.mems = r.list; STATE.staff = r.staffName;
      updAdm(r.list, r.totalRedeemed); poll();
    } else { route('v-home'); Swal.fire('éŒ¯èª¤', r.msg, 'error'); }
  }
}

function updAdm(list, tr) {
  $('#sn').innerText = STATE.staff; $('#ar').innerText = tr; $('#am').innerText = list.length;
  filter();
}

function renderG(list) {
  $('#ag').innerHTML = list.map(m => {
    const full = Math.floor(m.current/10), p = (m.current%10)*10;
    return `<div class="mc ${full>0?'has':''} ${m.isBirthdayToday?'bday':''}" onclick="act('${m.phone}')">
      <div class="b-bad">ğŸ‚</div><div class="c-bad">åˆ¸ ${full}</div>
      <div style="font-weight:500">${m.name}</div><div style="font-size:12px;color:#999;margin-bottom:5px">${m.phone}</div>
      <div style="font-size:12px;color:#aaa">é€²åº¦ ${m.current%10}/10</div>
      <div class="bar"><div class="fill" style="width:${p}%"></div></div>
    </div>`;
  }).join('');
}

function filter() { const k = $('#as').value.toLowerCase(); renderG(STATE.mems.filter(m=>m.name.includes(k)||m.phone.includes(k))); }

function poll() {
  if(STATE.timer) clearInterval(STATE.timer);
  STATE.timer = setInterval(async()=>{
    if($('#v-adm').classList.contains('active') && STATE.pass) {
      const r = await api('adminLoginAndGetData',{password:STATE.pass});
      if(r.success){ STATE.mems = r.list; updAdm(r.list, r.totalRedeemed); }
    }
  }, 20000);
}

// Admin Actions
function act(ph) {
  const m = STATE.mems.find(x=>x.phone==ph);
  if(!m) return;
  if(m.isBirthdayToday) { confetti({origin:{y:.7}}); toast('success', `${m.name} ç”Ÿæ—¥å¿«æ¨‚!`); }
  const full = Math.floor(m.current/10);
  
  Swal.fire({
    title:'', showConfirmButton:false,
    html: `
      <div class="ctrl-in">
        <div style="font-size:22px;font-weight:700;color:#333;margin-bottom:5px">${m.name}${m.isBirthdayToday?' ğŸ‚':''}</div>
        <div style="font-size:13px;color:#888;margin-bottom:15px">ç›®å‰ ${m.current} é» (åˆ¸ ${full})</div>
        <div class="btn-bon ${m.isFirstUsed?'used':''}" onclick="bonus('${ph}',${m.isFirstUsed})">${m.isFirstUsed?'ğŸ”’ å·²é ˜é¦–è³¼ç¦®':'ğŸ ç™¼é€é¦–è³¼ç¦® (+5)'}</div>
        <div class="num-d" id="nd">1</div>
        <div class="money-w"><span>$</span><input type="number" class="money-i" placeholder="é‡‘é¡" oninput="calc(this.value)"><span>= é»</span></div>
        <input type="range" id="rng" min="0" max="100" value="1" oninput="sync(this.value)">
      </div>
      <div class="acts">
        <button class="btn-sub" onclick="stamp('${ph}',-1)">æ‰£é™¤</button>
        <button class="btn-add" onclick="stamp('${ph}',1)">åŠ é»</button>
      </div>
      ${full>0 ? `<button class="btn-p" style="margin-top:15px;display:flex;justify-content:space-between;padding:12px 20px" onclick="admRedeem('${ph}')"><span>ğŸ« å…Œæ›åˆ¸</span><span>é¤˜ ${full}</span></button>`:''}
      <div class="link" onclick="hist('${ph}')">æŸ¥çœ‹ç´€éŒ„ ></div>
    `
  });
}

window.calc = v => sync(v ? Math.floor(v/100) : 0);
window.sync = v => { const r=$('#rng'); if(Number(v)>Number(r.max)) r.max=Number(v)+10; $('#nd').innerText=v; r.value=v; };

async function stamp(ph, mul) {
  const val = Number($('#nd').innerText), money = $('.money-i').value;
  load(); const r = await api('addStamp', {password:STATE.pass, phone:ph, amount:val*mul, money}); load(false);
  if(r.success) {
    play('s'); updLocal(ph, r.current, r.redeemed);
    act(ph); toast('success', `æˆåŠŸ${mul>0?'å¢åŠ ':'æ‰£é™¤'} ${val} é»`);
  } else { play('e'); Swal.fire('å¤±æ•—', r.msg, 'error'); }
}

async function admRedeem(ph) {
  Swal.close();
  const res = await Swal.fire({title:'ç¢ºèªå…Œæ›ï¼Ÿ',text:'æ‰£é™¤ 10 é»',icon:'warning',showCancelButton:true,confirmButtonText:'ç¢ºèª',confirmButtonColor:'#d33'});
  if(res.isConfirmed) {
    load(); const r = await api('redeemCard', {password:STATE.pass, phone:ph}); load(false);
    if(r.success) { play('r'); updLocal(ph, r.current, r.redeemed); act(ph); toast('success','å…Œæ›æˆåŠŸ'); }
    else { play('e'); Swal.fire('å¤±æ•—', r.msg, 'error'); }
  } else act(ph);
}

async function bonus(ph, used) {
  if(used) {
    const {value:p} = await Swal.fire({title:'å·²é ˜é',text:'å¼·åˆ¶è£œç™¼éœ€ç®¡ç†å“¡å¯†ç¢¼',input:'password',showCancelButton:true,confirmButtonColor:'#d33'});
    if(!p) return; STATE.pass = p; 
  }
  load(); const r = await api('giveFirstBonus', {password:STATE.pass, phone:ph, forceOverride:used}); load(false);
  if(r.success) { play('s'); updLocal(ph, r.current, r.redeemed, true); act(ph); toast('success', 'å·²ç™¼é€é¦–è³¼ç¦®'); }
  else { play('e'); Swal.fire('å¤±æ•—', r.msg, 'error'); }
}

function updLocal(ph, c, r, f=null) {
  const m = STATE.mems.find(x=>x.phone==ph);
  if(m) { m.current=c; m.redeemed=r; if(f!==null) m.isFirstUsed=f; updAdm(STATE.mems, $('#ar').innerText); }
}

async function hist(ph) {
  load(); const r = await api('getMemberHistory', {phone:ph}); load(false);
  if(!r.success) return Swal.fire('è®€å–å¤±æ•—');

  // Logic Check: Is Admin?
  const isAdmin = !!STATE.pass;

  const h = r.history.length ? r.history.map(x=>`
    <div style="padding:12px 5px;border-bottom:1px solid #f5f5f5;display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-size:14px;font-weight:500;color:${x.action.match(/åŠ |è´ˆ|è²»/)?'var(--g)':x.action.match(/æ‰£|å…Œ/)?'var(--p)':'#333'}">
          ${x.money?`$${x.money} `:''}${x.action}
        </div>
        <div style="font-size:11px;color:#aaa">${x.date}</div>
      </div>
      <div style="font-size:11px;background:#f0f0f0;padding:2px 8px;border-radius:8px;color:#888">
        ${isAdmin ? x.staff : 'ç„¡è²³è‰¯å“'}
      </div>
    </div>`).join('') : '<div style="color:#ccc;padding:20px;text-align:center">ç„¡ç´€éŒ„</div>';

  Swal.fire({
    title:'',
    html:`<div><div style="font-size:18px;font-weight:700;margin-bottom:15px">ğŸ“œ æ­·å²ç´€éŒ„</div><div style="max-height:300px;overflow-y:auto;text-align:left;border-top:1px solid #eee">${h}</div></div>`,
    confirmButtonColor:'#EFC050',
    confirmButtonText:'é—œé–‰'
  });
}

async function reg() {
  const isAdm = $('#v-adm').classList.contains('active');
  const {value:v} = await Swal.fire({
    title:'æ–°æœƒå“¡è¨»å†Š',
    html:`<input id="rn" placeholder="å§“å"><input id="rp" type="tel" placeholder="æ‰‹æ©Ÿ" maxlength="10"><input id="rb" type="date">`,
    confirmButtonText:'è¨»å†Š', showCancelButton:true, confirmButtonColor:'#9CB071',
    preConfirm:()=>{
      const n=$('#rn').value, p=$('#rp').value, b=$('#rb').value;
      return (!n||!p||!b||!/^09\d{8}$/.test(p)) ? Swal.showValidationMessage('è³‡æ–™ä¸å®Œæ•´æˆ–æ ¼å¼éŒ¯èª¤') : {name:n, phone:p, birthday:b};
    }
  });
  if(v) {
    load(); const r = await api('registerMember', {password:isAdm?STATE.pass:null, ...v}); load(false);
    if(r.success) { Swal.fire('æˆåŠŸ','','success'); if(isAdm) { const ar=await api('adminLoginAndGetData',{password:STATE.pass}); if(ar.success){STATE.mems=ar.list; updAdm(ar.list, ar.totalRedeemed);} } }
    else Swal.fire('å¤±æ•—', r.msg, 'error');
  }
}

function logout() { STATE.pass=""; sessionStorage.removeItem('SP'); stopLoad(); route('v-home'); }

window.onload = async () => {
  const p = new URLSearchParams(location.search).get('phone');
  if(p) { $('#hp').value=p; uLogin(); }
  const sp = sessionStorage.getItem('SP');
  if(sp) {
    STATE.pass=sp; route('v-adm'); $('#ag').innerHTML=Array(6).fill('<div class="mc skel" style="height:100px"></div>').join('');
    load(); const r=await api('adminLoginAndGetData',{password:sp}); load(false);
    if(r.success){ STATE.mems=r.list; STATE.staff=r.staffName; updAdm(r.list, r.totalRedeemed); poll(); } else { logout(); }
  }
};
</script>
</body>
</html>