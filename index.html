<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ç„¡è²³è‰¯å“é›†é»å¡</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root { 
      --brand-yellow: #EFC050; --brand-green: #9CB071; --brand-pink: #F7A8B8;
      --bg-main: #FAFAFA; --text-dark: #555; 
    }
    body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg-main); margin: 0; padding: 20px; color: var(--text-dark); overflow-x: hidden; -webkit-tap-highlight-color: transparent; }

    .view-section { display: none; min-height: 90vh; flex-direction: column; align-items: center; width: 100%; max-width: 500px; margin: 0 auto;}
    .view-section.active { display: flex; }

    h2 { margin: 10px 0 5px 0; letter-spacing: 2px; font-size: 24px; font-weight: 500; text-align: center;}
    .subtitle { color: #999; font-size: 13px; margin-bottom: 30px; letter-spacing: 1px; font-weight: 300; text-align: center;}
    
    input { 
      width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 25px; 
      font-size: 16px; text-align: center; margin-bottom: 15px; 
      background: #fff; color: #555; transition: 0.3s; box-sizing: border-box; font-family: 'Noto Sans TC';
    }
    input:focus { outline: none; border-color: var(--brand-yellow); box-shadow: 0 0 0 4px rgba(239, 192, 80, 0.1); }
    
    button { width: 100%; padding: 15px; border: none; border-radius: 25px; font-size: 16px; font-weight: 500; cursor: pointer; transition: 0.2s; font-family: 'Noto Sans TC'; margin-bottom: 15px;}
    button:active { transform: scale(0.98); }
    
    .btn-yellow { background-color: var(--brand-yellow); color: white; box-shadow: 0 8px 20px -5px rgba(239, 192, 80, 0.4); }
    .btn-green { background-color: var(--brand-green); color: white; box-shadow: 0 8px 20px -5px rgba(156, 176, 113, 0.4); }
    .btn-pink { background-color: var(--brand-pink); color: white; box-shadow: 0 8px 20px -5px rgba(247, 168, 184, 0.4); }
    .btn-outline { background: white; border: 1px solid #ddd; color: #888; }
    .btn-admin { background: white; color: var(--brand-green); border: 1px solid var(--brand-green); font-size: 14px; padding: 12px; }
    .btn-register { background-color: white; border: 2px solid var(--brand-yellow); color: var(--brand-yellow); }

    .home-card { background: white; padding: 50px 30px; border-radius: 30px; box-shadow: 0 15px 35px -10px rgba(0,0,0,0.08); width: 100%; box-sizing: border-box; text-align: center;}
    .divider { margin: 25px 0; display: flex; align-items: center; justify-content: center; color: #ccc; font-size: 12px; font-weight: 300; }
    .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid #eee; margin: 0 10px; }

    .rule-link { margin-top: 10px; font-size: 13px; color: #aaa; text-decoration: underline; cursor: pointer; display: block;}

    /* User Card */
    .card-display { background: white; width: 100%; padding: 30px 25px; border-radius: 35px; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.08); position: relative; overflow: hidden; box-sizing: border-box; margin-bottom: 20px;}
    .card-display::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px; background: linear-gradient(to right, var(--brand-pink), var(--brand-yellow), var(--brand-green)); }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;}
    .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; justify-items: center;}
    .stamp { width: 40px; height: 40px; border-radius: 50%; background: #F5F5F5; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #CCC; transition: 0.3s; }
    .stamp.active { background: var(--brand-pink); color: white; transform: scale(1.1); box-shadow: 0 5px 15px rgba(247, 168, 184, 0.4);}
    .stamp.active.anim { animation: pop 0.5s ease; }
    @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1.1); opacity: 1; } }
    
    .coupon-wallet { background: #FFF8E1; border: 2px dashed #EFC050; border-radius: 20px; padding: 15px; margin-top: 25px; text-align: center; display: none; }
    .coupon-count { font-size: 32px; font-weight: bold; color: #EFC050; margin: 5px 0; }
    .btn-use-coupon { background: #EFC050; color: white; font-size: 14px; padding: 8px 20px; border-radius: 15px; width: auto; margin: 0; box-shadow: 0 4px 10px rgba(239, 192, 80, 0.3); }

    /* Admin UI */
    .admin-nav { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 15px;}
    .btn-back-home { background: transparent; color: #888; border: 1px solid #eee; padding: 5px 15px; font-size: 12px; width: auto; margin: 0; border-radius: 15px;}
    .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-bottom: 20px;}
    .stat-box { background: white; padding: 15px; border-radius: 20px; text-align: center; border-bottom: 4px solid #eee; }
    .stat-val { font-size: 22px; font-weight: 500; color: #333; }
    .stat-label { font-size: 11px; color: #999; }
    .search-group { display: flex; gap: 10px; margin-bottom: 20px; }
    .search-group input { margin-bottom: 0; flex: 1; text-align: left; padding-left: 20px; }
    
    .member-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; width: 100%; padding-bottom: 80px;}
    .m-card { background: white; border-radius: 20px; padding: 15px; cursor: pointer; border: 2px solid transparent; transition: 0.2s; position: relative;}
    .m-card:active { transform: scale(0.98); }
    .m-card.has-coupon { border-color: var(--brand-pink); background: #FFFBFB; }
    .bar-bg { height: 6px; background: #eee; border-radius: 3px; margin-top: 10px; overflow: hidden;}
    .bar-fill { height: 100%; background: var(--brand-green); width: 0%; transition: 0.3s; }
    .m-card.has-coupon .bar-fill { background: var(--brand-pink); }
    .coupon-badge { position: absolute; top: 10px; right: 10px; font-size: 10px; background: var(--brand-pink); color: white; padding: 2px 8px; border-radius: 8px; display: none; }
    .m-card.has-coupon .coupon-badge { display: block; }
    
    /* å£½æ˜Ÿæ¨™è¨˜ */
    .bday-badge { position: absolute; top: 10px; left: 10px; font-size: 16px; display: none; }
    .m-card.is-birthday .bday-badge { display: block; animation: bounce 1s infinite; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

    .fab { position: fixed; bottom: 30px; right: 30px; width: 55px; height: 55px; background: var(--brand-green); color: white; border-radius: 50%; font-size: 28px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 20px -5px rgba(156, 176, 113, 0.5); cursor: pointer; z-index: 100;}

    /* Control Panel (Popup) */
    .ctrl-panel { text-align: center; }
    .ctrl-info { margin-bottom: 15px; }
    .ctrl-info .name { font-size: 22px; font-weight: bold; color: #333; margin-bottom: 5px; }
    .ctrl-info .detail { font-size: 13px; color: #888; }
    
    .ctrl-input-area { background: #f9f9f9; padding: 20px; border-radius: 20px; margin-bottom: 20px; }
    .num-display { font-size: 48px; font-weight: bold; color: var(--brand-green); margin-bottom: 10px; line-height: 1; }
    
    .money-input-wrapper { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 15px; }
    .money-input { width: 100px; padding: 5px 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 14px; margin: 0; text-align: center; }
    
    .range-wrap { margin: 15px 0 5px 0; padding: 0 10px; }
    input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%;
      background: white; border: 2px solid var(--brand-green); cursor: pointer; margin-top: -10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #ddd; border-radius: 2px; }

    .ctrl-actions { display: flex; gap: 10px; }
    .btn-act-add { flex: 2; background: var(--brand-green); color: white; border-radius: 15px; padding: 12px; font-size: 15px; border:none; box-shadow: 0 4px 10px rgba(156, 176, 113, 0.3); }
    .btn-act-sub { flex: 1; background: white; color: #E57373; border: 1px solid #E57373; border-radius: 15px; padding: 12px; font-size: 15px; }
    .btn-act-redeem { width: 100%; margin-top: 15px; background: var(--brand-pink); color: white; border-radius: 15px; padding: 12px; border:none; font-size: 15px; display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; box-shadow: 0 4px 10px rgba(247, 168, 184, 0.3);}
    
    /* é¦–è³¼æŒ‰éˆ•æ¨£å¼ */
    .btn-bonus { background: #FFF3E0; color: #FF9800; font-size: 14px; padding: 8px 15px; border-radius: 20px; border: 1px solid #FFE0B2; margin-bottom: 10px; cursor: pointer; width: auto; display: inline-block; transition:0.2s;}
    .btn-bonus.used { background: #EEE; color: #AAA; border-color: #DDD; cursor: default; }
    
    .history-link { display: block; margin-top: 15px; color: #aaa; font-size: 12px; text-decoration: underline; cursor: pointer; }

    /* History Styles */
    .hist-header { display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #555; white-space: nowrap; }
    .hist-list { max-height: 300px; overflow-y: auto; text-align: left; border-top: 1px solid #eee; }
    .hist-item { padding: 12px 5px; border-bottom: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center; }
    .hist-act { font-size: 14px; font-weight: 500; color: #333; margin-bottom: 3px; }
    .hist-time { font-size: 11px; color: #aaa; }
    .hist-staff { font-size: 11px; background: #f0f0f0; padding: 2px 8px; border-radius: 8px; color: #888; margin-left: 5px;}
    .hist-money { font-size: 13px; font-weight: bold; color: var(--brand-yellow); background: #FFF8E1; padding: 2px 6px; border-radius: 5px; margin-left: auto; margin-right: 5px;}
    
    .act-type-plus { color: var(--brand-green); }
    .act-type-minus { color: #E57373; }
    .act-type-redeem { color: var(--brand-pink); }

    /* éª¨æ¶å±å‹•ç•« */
    @keyframes skeleton-loading {
      0% { background-color: #f0f0f0; }
      50% { background-color: #e0e0e0; }
      100% { background-color: #f0f0f0; }
    }
    .skeleton {
      animation: skeleton-loading 1.5s infinite;
      color: transparent !important;
      background: #f0f0f0;
      border-radius: 8px;
      user-select: none;
    }
    .skeleton-text {
      width: 100%;
      height: 1em;
      display: inline-block;
    }

    /* SweetAlert Override */
    div:where(.swal2-popup) { border-radius: 30px !important; padding: 25px !important; width: 85% !important; max-width: 360px !important; } 
    div:where(.swal2-actions) { width: 100% !important; margin: 15px 0 0 0 !important; }
    div:where(.swal2-actions) button { border-radius: 15px !important; flex: 1 !important; margin: 0 5px !important;}
    div:where(.swal2-html-container) { margin: 0 !important; overflow: visible !important; }

    #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
    .spin-emoji { font-size: 40px; display: inline-block; animation: spin 1.2s linear infinite; }
    .spin-emoji:nth-child(2) { animation-delay: 0.2s; } .spin-emoji:nth-child(3) { animation-delay: 0.4s; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="loader">
    <div style="display:flex; gap:10px;">
      <span class="spin-emoji">ğŸ‹</span><span class="spin-emoji">ğŸŒ¿</span><span class="spin-emoji">ğŸŒ¸</span>
    </div>
    <div style="font-size:12px; color:#aaa; margin-top:15px; letter-spacing: 2px;">PROCESSING...</div>
    <button onclick="forceStopLoading()" style="width: auto; margin-top: 30px; padding: 8px 25px; background: white; border: 1px solid #ddd; border-radius: 20px; color: #999; font-size: 13px;">âœ• å–æ¶ˆ</button>
  </div>

  <div id="view-home" class="view-section active">
    <div class="home-card">
      <h2 style="color:var(--brand-green);">ç„¡è²³è‰¯å“</h2>
      <div class="subtitle">é›†é»æœƒå“¡ç³»çµ±</div>
      <input type="tel" id="homePhone" placeholder="è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼" maxlength="10">
      <button class="btn-yellow" onclick="userLogin()">æŸ¥è©¢é›†é»å¡</button>
      <button class="btn-register" onclick="openRegister()">ç«‹å³è¨»å†Šæœƒå“¡</button>
      <div class="rule-link" onclick="showRules()">ğŸ“ æŸ¥çœ‹é›†é»è¦å‰‡</div>
      <div class="divider">STAFF ONLY</div>
      <button class="btn-admin" onclick="openAdminLogin()">å·¥ä½œå¤¥ä¼´å…¥å£</button>
    </div>
  </div>

  <div id="view-user" class="view-section">
    <h2 style="margin-top: 30px;">æˆ‘çš„é›†é»å¡</h2>
    <div class="subtitle" style="margin-bottom: 20px;">ç„¡è²³è‰¯å“</div>
    <div class="card-display" id="userCard">
      <div class="card-header">
        <div style="font-size:18px; font-weight:500; display:flex; align-items:center;">
          æœƒå“¡å¡
        </div>
        <div style="background:#f5f5f5; color:#999; padding:4px 12px; border-radius:15px; font-size:12px;" id="uName">Name</div>
      </div>
      <div class="grid" id="uGrid"></div>
      <div id="uFullMsg" style="text-align:center; margin-top:20px; display:none;">
        <div style="color:var(--brand-pink); font-weight:500; font-size:16px; margin-bottom:5px;">ğŸ‰ å·²é›†æ»¿ 10 é»ï¼</div>
        <div style="color:var(--brand-yellow); font-weight:bold; font-size:18px; letter-spacing:1px; border:2px dashed var(--brand-yellow); padding:10px; border-radius:15px; background:#fffdf5;">
          ç²å¾— 9 æŠ˜å…Œæ›åˆ¸
        </div>
      </div>
      <div id="couponWallet" class="coupon-wallet">
        <div class="coupon-desc">âœ¨ å¯ç”¨å„ªæƒ åˆ¸ (å¯ç´¯ç©)</div>
        <div class="coupon-count"><span id="uCouponCount">0</span> å¼µ</div>
        <button class="btn-use-coupon" onclick="userRedeem()">ç«‹å³å…Œæ›æŠ˜æ‰£</button>
      </div>
      <div style="text-align:center; margin-top:30px; font-size:13px; color:#999;">
        æ­·å²ä½¿ç”¨ï¼š<span id="uRedeem" style="color:var(--brand-yellow); font-weight:500; font-size:16px; cursor:pointer; text-decoration:underline;" onclick="openHistory(CURRENT_PHONE)">0</span> å¼µ
      </div>
    </div>
    <div class="rule-link" onclick="showRules()" style="text-align:center; margin-bottom:20px;">ğŸ“ æŸ¥çœ‹é›†é»è¦å‰‡</div>
    <button class="btn-outline" onclick="showView('view-home')">â†º è¿”å›æŸ¥è©¢</button>
  </div>

  <div id="view-admin" class="view-section">
    <div class="admin-nav">
      <div style="font-weight:500; display:flex; align-items:center; gap:5px;">
        ç„¡è²³å¾Œå° <span id="staffNameDisplay" style="font-size:12px; background:#E8F5E9; color:#4CAF50; padding:2px 8px; border-radius:10px;">Guest</span>
      </div>
      <button class="btn-back-home" onclick="logoutAdmin()">ç™»å‡º</button>
    </div>
    <div class="dashboard">
      <div class="stat-box" style="border-color:var(--brand-pink)">
        <div class="stat-label">å„ªæƒ åˆ¸ç´¯ç©å·²å…Œæ›</div>
        <div class="stat-val" id="admRedeemTotal">0</div>
      </div>
      <div class="stat-box" style="border-color:var(--brand-yellow)">
        <div class="stat-label">æœƒå“¡ç¸½æ•¸</div>
        <div class="stat-val" id="admMemberTotal">0</div>
      </div>
    </div>
    <div class="search-group">
      <input type="text" id="admSearch" placeholder="ğŸ” æœå°‹æœƒå“¡é›»è©±/å§“å..." onkeyup="filterAdminList()">
    </div>
    <div class="member-grid" id="admGrid"></div>
    <div class="fab" onclick="openRegister()">ï¼‹</div>
  </div>

  <script>
    // â˜… å·²å¡«å…¥ä½ çš„ ID
    const API_URL = "https://script.google.com/macros/s/AKfycbwsfPMn54aqd3u-4SHkGmdfS-drw8MLNE-3lVq1XP-pCPSOW1ZxwDvTnd-85uQpuuc/exec"; 
    
    const SOUND_SUCCESS = new Audio('https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg'); 
    const SOUND_REDEEM = new Audio('https://actions.google.com/sounds/v1/science_fiction/scifi_laser.ogg'); 
    const SOUND_ERROR = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg'); 

    function playSound(type) {
      try {
        if(type === 'success') { SOUND_SUCCESS.currentTime = 0; SOUND_SUCCESS.play(); }
        if(type === 'redeem') { SOUND_REDEEM.currentTime = 0; SOUND_REDEEM.play(); }
        if(type === 'error') { SOUND_ERROR.currentTime = 0; SOUND_ERROR.play(); }
      } catch(e) { console.log("Audio error"); }
    }
    
    function fireConfetti() {
       confetti({ origin: { y: 0.7 } });
    }

    let GLOBAL_PASS = ""; 
    let GLOBAL_STAFF_NAME = "";
    let ALL_MEMBERS = [];
    let CURRENT_PHONE = "";
    let POLLING_TIMER = null; 

    // API å‘¼å«å‡½å¼
    async function callApi(action, params = {}) {
      const payload = { action: action, params: params };
      try {
        const response = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify(payload),
          headers: { "Content-Type": "text/plain;charset=utf-8" }, 
        });
        const result = await response.json();
        return result;
      } catch (error) {
        console.error("API Error:", error);
        return { success: false, msg: "é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦" };
      }
    }

    // æœ¬åœ°æ¥µé€Ÿæ›´æ–°å°å¹«æ‰‹
    function updateLocalMember(phone, newPoints, newRedeemed, isFirstUsed = null) {
      let target = ALL_MEMBERS.find(m => m.phone === phone);
      if (target) {
        target.current = newPoints;
        target.redeemed = newRedeemed;
        if(isFirstUsed !== null) target.isFirstUsed = isFirstUsed;
        updateAdminUI(ALL_MEMBERS, document.getElementById('admRedeemTotal').innerText); 
      }
    }
    
    function showLoading() { startFunLoading(); }
    function hideLoading() { stopFunLoading(); }
    
    function forceStopLoading() {
      if(POLLING_TIMER) clearInterval(POLLING_TIMER);
      GLOBAL_PASS = ""; hideLoading(); showView('view-home');
    }

    // éš¨æ©Ÿå¹¹è©± Loader
    let FUN_LOADER_TIMER = null;
    const LOADING_MSGS = [
      "æ­£åœ¨å¬å–šé›²ç«¯è³‡æ–™...",
      "åº—é•·æ­£åœ¨ç¿»é–±é»åç°¿...",
      "è¨Šè™Ÿæ­£åœ¨é£›å¾€ Google...",
      "æ­£åœ¨è¨ˆç®—æ‚¨çš„å„ªæƒ ...",
      "ç¨ç­‰ä¸€ä¸‹ï¼Œè²“å’ªæ“‹åœ¨ä¸»æ©Ÿå‰...",
      "å¿«åˆ°äº†ï¼Œå†å¿è€ä¸€ä¸‹...",
      "æ­£åœ¨å¹«æ‚¨æŠŠé»æ•¸æ“¦äº®...",
      "ç„¡è²³è‰¯å“ï¼Œå“è³ªä¿è­‰..."
    ];

    function startFunLoading() {
      document.getElementById('loader').style.display = 'flex';
      const msgEl = document.querySelector('#loader div[style*="font-size:12px"]'); 
      let i = 0;
      msgEl.innerText = LOADING_MSGS[0];
      if(FUN_LOADER_TIMER) clearInterval(FUN_LOADER_TIMER);
      FUN_LOADER_TIMER = setInterval(() => {
        i = (i + 1) % LOADING_MSGS.length;
        msgEl.innerText = LOADING_MSGS[i];
      }, 1500);
    }

    function stopFunLoading() {
      if(FUN_LOADER_TIMER) clearInterval(FUN_LOADER_TIMER);
      document.getElementById('loader').style.display = 'none';
    }

    function startPolling() {
      if(POLLING_TIMER) clearInterval(POLLING_TIMER);
      POLLING_TIMER = setInterval(async () => {
        // ä½¿ç”¨è€…æ¨¡å¼ä¸éœ€é »ç¹è¼ªè©¢
        if(document.getElementById('view-admin').classList.contains('active') && GLOBAL_PASS) {
          // å¾Œå°æ¨¡å¼æ‰éœ€è¦æ›´æ–°åˆ—è¡¨
          const r = await callApi('adminLoginAndGetData', { password: GLOBAL_PASS });
          if(r.success) { ALL_MEMBERS = r.list; updateAdminUI(r.list, r.totalRedeemed); }
        }
      }, 20000); 
    }

    function showView(viewId) {
      document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
      document.getElementById(viewId).classList.add('active');
      window.scrollTo(0,0);
    }

    function showRules() {
      Swal.fire({
        title: 'é›†é»è¦å‰‡èªªæ˜',
        html: `
          <div style="text-align:left; font-size:14px; line-height:1.8; color:#555;">
            1. <b>é¦–æ¬¡æ¶ˆè²»</b>ï¼šå¯ç›´æ¥ç²è´ˆ <b>5 é»</b>ã€‚<br>
            2. <b>æ¶ˆè²»é›†é»</b>ï¼šæ¯æ¶ˆè²» <b>100å…ƒ</b> å¯ç²å¾— 1 é»ã€‚<br>
            3. <b>é›†æ»¿å›é¥‹</b>ï¼šé›†æ»¿ 10 é»å¯ç²å¾—ä¸€å¼µã€Œ9æŠ˜å…Œæ›åˆ¸ã€ã€‚<br>
            4. <b>å…Œæ›ä½¿ç”¨</b>ï¼šå…Œæ›åˆ¸å¯ç´¯ç©ä½¿ç”¨ï¼Œå–®æ¬¡æ¶ˆè²»é™ç”¨ä¸€å¼µã€‚
          </div>
        `,
        confirmButtonColor: '#EFC050',
        confirmButtonText: 'äº†è§£'
      });
    }

    async function userLogin() {
      let p = document.getElementById('homePhone').value.trim();
      if(!p) return Swal.fire('è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼');
      
      CURRENT_PHONE = p;
      showView('view-user'); // ç¬é–“åˆ‡æ›
      
      // é¡¯ç¤ºéª¨æ¶å±
      document.getElementById('uName').innerHTML = '<span class="skeleton skeleton-text" style="width: 80px;"></span>';
      document.getElementById('uRedeem').innerHTML = '<span class="skeleton skeleton-text" style="width: 20px;"></span>';
      document.getElementById('uCouponCount').innerText = '-';
      
      let skeletonGrid = '';
      for(let i=0; i<10; i++) skeletonGrid += `<div class="stamp skeleton"></div>`;
      document.getElementById('uGrid').innerHTML = skeletonGrid;
      
      document.getElementById('uFullMsg').style.display = 'none';
      document.getElementById('couponWallet').style.display = 'none';

      startFunLoading(); 

      const res = await callApi('getMemberData', { phone: p });
      
      stopFunLoading();

      if(res.success) {
        renderUserCard(res.name, res.current, res.redeemed);
        // â˜… å¦‚æœæ˜¯å£½æ˜Ÿï¼Œæ’’èŠ±ç‰¹æ•ˆ + å½ˆçª—
        if(res.isBirthday) {
            fireConfetti();
            Swal.fire({
                title: 'ğŸ‚ ç”Ÿæ—¥å¿«æ¨‚ï¼',
                text: 'ä»Šå¤©æ˜¯æ‚¨çš„ç”Ÿæ—¥ï¼Œç„¡è²³è‰¯å“ç¥æ‚¨ç”Ÿæ—¥å¿«æ¨‚ï¼',
                icon: 'success',
                confirmButtonColor: '#F7A8B8'
            });
        }
      } else {
        Swal.fire({ icon: 'error', title: 'æ‰¾ä¸åˆ°æœƒå“¡', text: 'è«‹å…ˆè¨»å†Šæœƒå“¡å–”ï¼', confirmButtonText: 'å»è¨»å†Š', confirmButtonColor: '#EFC050' }).then(r => { 
          if(r.isConfirmed) openRegister(); 
          showView('view-home');
        });
      }
    }

    function renderUserCard(name, currentTotal, redeemed) {
      document.getElementById('uName').innerText = name;
      document.getElementById('uRedeem').innerText = redeemed;
      
      let fullCards = Math.floor(currentTotal / 10);
      let progress = currentTotal % 10;
      let html = '';
      for(let i=1; i<=10; i++) {
        let cls = (i <= progress) ? 'stamp active anim' : 'stamp';
        let style = (i <= progress) ? `style="animation-delay:${i*0.05}s"` : '';
        html += `<div class="${cls}" ${style}>${i}</div>`;
      }
      document.getElementById('uGrid').innerHTML = html;
      document.getElementById('uFullMsg').style.display = (progress>=10) ? 'block':'none';
      let wallet = document.getElementById('couponWallet');
      if (fullCards > 0) {
        wallet.style.display = 'block';
        document.getElementById('uCouponCount').innerText = fullCards;
      } else {
        wallet.style.display = 'none';
      }
    }

    async function userRedeem() {
      const result = await Swal.fire({ 
        title: 'åº—å“¡ç¢ºèªå…Œæ›', text: 'è«‹å°‡æ‰‹æ©Ÿäº¤çµ¦åº—å“¡è¼¸å…¥å¯†ç¢¼', input: 'password', 
        showCancelButton: true, confirmButtonText: 'ç¢ºèª', confirmButtonColor: '#9CB071' 
      });

      if (result.isConfirmed) {
        showLoading();
        const res = await callApi('redeemCard', { password: result.value, phone: CURRENT_PHONE });
        hideLoading();
        
        if(res.success) {
          playSound('redeem'); Swal.fire({icon: 'success', title: 'å…Œæ›æˆåŠŸï¼', timer: 1500, showConfirmButton: false});
          renderUserCard(document.getElementById('uName').innerText, res.current, res.redeemed);
        } else { 
          playSound('error'); Swal.fire({icon: 'error', title: 'å…Œæ›å¤±æ•—', text: res.msg}); 
        }
      }
    }

    // å¾Œå°ç™»å…¥ä¹ŸåŠ å…¥éª¨æ¶å±é‚è¼¯
    async function openAdminLogin() {
      const res = await Swal.fire({
        title: 'å·¥ä½œå¤¥ä¼´ç™»å…¥', input: 'password', inputPlaceholder: 'è«‹è¼¸å…¥å¯†ç¢¼', confirmButtonColor: '#9CB071'
      });

      if(res.isConfirmed) {
        GLOBAL_PASS = res.value;
        
        // â˜… ç«‹å³åˆ‡æ›åˆ° Admin é é¢ï¼Œé¡¯ç¤ºéª¨æ¶
        showView('view-admin');
        renderAdminSkeleton();
        
        startFunLoading();
        const r = await callApi('adminLoginAndGetData', { password: GLOBAL_PASS });
        stopFunLoading();
        
        if(r.success) {
          sessionStorage.setItem('STAFF_PASS', GLOBAL_PASS); 
          ALL_MEMBERS = r.list;
          GLOBAL_STAFF_NAME = r.staffName;
          updateAdminUI(r.list, r.totalRedeemed);
          startPolling(); 
        } else { 
          showView('view-home'); // å¤±æ•—å›é¦–é 
          Swal.fire('ç™»å…¥å¤±æ•—', r.msg, 'error'); 
        }
      }
    }
    
    // â˜… Admin éª¨æ¶å±
    function renderAdminSkeleton() {
        let box = document.getElementById('admGrid');
        let html = '';
        for(let i=0; i<6; i++) {
            html += `<div class="m-card skeleton" style="height:100px;"></div>`;
        }
        box.innerHTML = html;
        document.getElementById('staffNameDisplay').innerText = 'Loading...';
    }

    function updateAdminUI(list, totalRedeem) {
      document.getElementById('staffNameDisplay').innerText = GLOBAL_STAFF_NAME;
      document.getElementById('admRedeemTotal').innerText = totalRedeem;
      document.getElementById('admMemberTotal').innerText = list.length;
      filterAdminList(); 
    }

    function renderAdminGrid(list) {
      let box = document.getElementById('admGrid');
      let htmlBuffer = ""; 
      list.forEach(m => {
        let fullCards = Math.floor(m.current / 10);
        let progress = m.current % 10;
        let p = (progress/10)*100;
        let hasCouponClass = fullCards > 0 ? 'has-coupon' : '';
        let bdayClass = m.isBirthdayToday ? 'is-birthday' : ''; // å£½æ˜Ÿæ¨£å¼
        
        htmlBuffer += `
          <div class="m-card ${hasCouponClass} ${bdayClass}" onclick="adminAction('${m.phone}', '${m.name}', ${m.current}, ${m.isFirstUsed}, ${m.isBirthdayToday})">
            <div class="bday-badge">ğŸ‚</div>
            <div class="coupon-badge">æŒæœ‰ ${fullCards} å¼µåˆ¸</div>
            <div style="font-weight:500;">${m.name}</div>
            <div style="font-size:12px; color:#999; margin-bottom:5px;">${m.phone}</div>
            <div style="font-size:12px; color:#aaa;">é€²åº¦ï¼š${progress}/10</div>
            <div class="bar-bg"><div class="bar-fill" style="width:${p}%"></div></div>
          </div>`;
      });
      box.innerHTML = htmlBuffer; 
    }

    function filterAdminList() {
      let key = document.getElementById('admSearch').value.toLowerCase();
      let res = ALL_MEMBERS.filter(m => m.name.toLowerCase().includes(key) || m.phone.includes(key));
      renderAdminGrid(res);
    }

    function adminAction(phone, name, currentTotal, isFirstUsed, isBirthdayToday) {
      if(isBirthdayToday) {
          fireConfetti();
          Swal.fire({
             title: `ğŸ‚ ä»Šå¤©æ˜¯ ${name} ç”Ÿæ—¥ï¼`,
             text: 'è¨˜å¾—é€å°ç¦®ç‰©å–”ï¼',
             icon: 'success',
             timer: 2000,
             showConfirmButton: false
          });
      }

      let fullCards = Math.floor(currentTotal / 10);
      let progress = currentTotal % 10;
      let redeemBtnHtml = fullCards > 0 
        ? `<button class="btn-act-redeem" onclick="doRedeem('${phone}')"><span>ğŸ« å…Œæ›ä¸€å¼µå„ªæƒ åˆ¸</span><span>(åº«å­˜ ${fullCards} å¼µ)</span></button>` 
        : '';
      
      let bonusBtnClass = isFirstUsed ? "btn-bonus used" : "btn-bonus";
      let bonusBtnText = isFirstUsed ? "ğŸ é¦–æ¬¡æ¶ˆè²» (+5) [å·²é ˜å–]" : "ğŸ é¦–æ¬¡æ¶ˆè²» (+5)";
      let bonusIcon = isFirstUsed ? "ğŸ”’" : "ğŸ";
      
      let nameDisplay = isBirthdayToday ? `${name} <span style="font-size:14px; color:#F7A8B8">ğŸ‚å£½æ˜Ÿ</span>` : name;

      Swal.fire({
        title: '',
        html: `
          <div class="ctrl-panel">
            <div class="ctrl-info">
              <div class="name">${nameDisplay}</div>
              <div class="detail">ç›®å‰ ${currentTotal} é» (æŒæœ‰ ${fullCards} å¼µ + ${progress} é»)</div>
            </div>
            
            <div class="ctrl-input-area">
              <div class="${bonusBtnClass}" onclick="handleFirstBonus('${phone}', ${isFirstUsed})">
                 ${bonusIcon} ${bonusBtnText.replace("ğŸ ","")}
              </div>
              
              <div class="num-display" id="numDisplay">1</div>
              
              <div class="money-input-wrapper">
                <span style="font-size:12px; color:#888;">æ¶ˆè²»é‡‘é¡ $</span>
                <input type="number" class="money-input" id="moneyInput" placeholder="è¼¸å…¥é‡‘é¡" oninput="calcPoints(this.value)">
                <span style="font-size:12px; color:#888;">= é»æ•¸</span>
              </div>

              <div class="range-wrap">
                <input type="range" id="rangeInput" min="0" max="50" value="1" oninput="syncVal(this.value)">
              </div>
            </div>

            <div class="ctrl-actions">
              <button class="btn-act-sub" onclick="doStampRange('${phone}', -1)">æ‰£é™¤</button>
              <button class="btn-act-add" onclick="doStampRange('${phone}', 1)">ç¢ºèªåŠ é»</button>
            </div>

            ${redeemBtnHtml}
            <div class="history-link" onclick="openHistory('${phone}')">æŸ¥çœ‹æ­·å²ç´€éŒ„ ></div>
          </div>
        `,
        showConfirmButton: false
      });
    }

    window.handleFirstBonus = async function(phone, isUsed) {
      if (!isUsed) {
        callBonusApi(phone, false);
      } else {
        const res = await Swal.fire({
          title: 'å·²é ˜å–éé¦–è³¼ç¦®', text: 'å¦‚éœ€å¼·åˆ¶è£œç™¼ï¼Œè«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼', input: 'password', showCancelButton: true, confirmButtonText: 'å¼·åˆ¶ç™¼é€', confirmButtonColor: '#d33'
        });
        if (res.isConfirmed) {
          GLOBAL_PASS = res.value; 
          callBonusApi(phone, true);
        }
      }
    }

    async function callBonusApi(phone, force) {
       Swal.close(); 
       showLoading();
       const r = await callApi('giveFirstBonus', { password: GLOBAL_PASS, phone: phone, forceOverride: force });
       hideLoading();
       
       if(r.success) {
         playSound('success');
         Swal.fire({ icon: 'success', title: `æˆåŠŸç™¼é€é¦–è³¼ç¦® (+5é»)`, timer: 1500, showConfirmButton: false });
         updateLocalMember(phone, r.current, r.redeemed, true);
       } else {
         playSound('error'); Swal.fire('ç™¼é€å¤±æ•—', r.msg, 'error');
       }
    }

    // â˜… ä¿®æ”¹ï¼šç§»é™¤é»æ•¸ä¸Šé™ 20 çš„é™åˆ¶
    window.calcPoints = function(money) {
      if(!money) { syncVal(0); return; } 
      let pts = Math.floor(money / 100);
      // if(pts > 20) pts = 20; // ç§»é™¤é€™è¡Œ
      syncVal(pts);
    }
    
    // â˜… ä¿®æ”¹ï¼šå¦‚æœæ•¸å€¼è¶…éæ‹‰æ¡¿ä¸Šé™ï¼Œè‡ªå‹•æ’é–‹æ‹‰æ¡¿
    window.syncVal = function(val) { 
      let slider = document.getElementById('rangeInput');
      if(Number(val) > Number(slider.max)) {
          slider.max = Number(val) + 10; // çµ¦ä¸€é»ç·©è¡ç©ºé–“
      }
      document.getElementById('numDisplay').innerText = val; 
      slider.value = val;
    }

    window.doStampRange = async function(phone, multiplier) {
      // â˜… ä¿®æ”¹ï¼šç›´æ¥è®€å–æ•¸å­—é¡¯ç¤ºå€çš„å€¼ï¼Œç¢ºä¿ä¸æœƒå› ç‚º Slider é™åˆ¶è€Œå°‘ç®—
      let val = Number(document.getElementById('numDisplay').innerText);
      let moneyVal = document.getElementById('moneyInput').value; 
      let finalAmount = val * multiplier;
      let actionText = multiplier > 0 ? "å¢åŠ " : "æ‰£é™¤";
      
      Swal.close(); showLoading();
      
      const r = await callApi('addStamp', { 
        password: GLOBAL_PASS, 
        phone: phone, 
        amount: finalAmount, 
        money: moneyVal 
      });
      
      hideLoading();

      if(r.success) {
        playSound('success'); 
        Swal.fire({ icon: 'success', title: `æˆåŠŸ${actionText} ${val} é»`, timer: 1000, showConfirmButton: false });
        updateLocalMember(phone, r.current, r.redeemed); 
      } else { 
        playSound('error'); Swal.fire('æ“ä½œå¤±æ•—', r.msg, 'error'); 
      }
    }

    window.doRedeem = async function(phone) {
      Swal.close();
      const result = await Swal.fire({ title: 'ç¢ºèªå…Œæ›ï¼Ÿ', text: 'å°‡æ‰£é™¤ 10 é»', icon: 'warning', showCancelButton: true, confirmButtonText: 'ç¢ºèª', confirmButtonColor: '#d33' });
      
      if (result.isConfirmed) {
        showLoading();
        const r = await callApi('redeemCard', { password: GLOBAL_PASS, phone: phone });
        hideLoading();

        if(r.success) {
          playSound('redeem'); Swal.fire('å…Œæ›æˆåŠŸ', '', 'success');
          updateLocalMember(phone, r.current, r.redeemed);
        } else { playSound('error'); Swal.fire('å¤±æ•—', r.msg, 'error'); }
      }
    }

    window.openHistory = async function(phone) {
      showLoading();
      const res = await callApi('getMemberHistory', { phone: phone });
      hideLoading();

      if(res.success) {
        let html = "";
        if(res.history.length === 0) {
          html = "<div style='color:#ccc; padding:20px; text-align:center;'>å°šç„¡ç´€éŒ„</div>";
        } else {
          html = `<div class="hist-list">`;
          res.history.forEach(h => {
            let typeClass = '';
            if(h.action.includes('è“‹ç« ') || h.action.includes('é¦–æ¬¡') || h.action.includes('æ¶ˆè²»') || h.action.includes('å¢åŠ ')) typeClass = 'act-type-plus';
            if(h.action.includes('æ‰£é»') || h.action.includes('æ‰£é™¤')) typeClass = 'act-type-minus';
            if(h.action.includes('å…Œæ›')) typeClass = 'act-type-redeem';
            
            let displayAction = h.action;
            if(h.money && h.money > 0) {
                if(displayAction.includes('æ¶ˆè²»ç´€éŒ„')) {
                     displayAction = `æ¶ˆè²»$${h.money}`;
                } else {
                     displayAction = `æ¶ˆè²»$${h.money} ${displayAction}`;
                }
            }

            html += `
              <div class="hist-item">
                <div>
                  <div class="hist-act ${typeClass}">${displayAction}</div>
                  <div class="hist-time">${h.date}</div>
                </div>
                <div class="hist-staff">${h.staff}</div>
              </div>`;
          });
          html += `</div>`;
        }
        Swal.fire({ title: '', html: `<div><div class="hist-header">ğŸ“œ æ­·å²ç´€éŒ„</div>${html}</div>`, confirmButtonColor: '#EFC050', confirmButtonText: 'é—œé–‰' });
      } else { Swal.fire('è®€å–å¤±æ•—', res.msg, 'error'); }
    }

    async function openRegister() {
      let isAdminMode = document.getElementById('view-admin').classList.contains('active');
      const res = await Swal.fire({
        title: 'æ–°æœƒå“¡è¨»å†Š',
        html: `
            <div style="text-align:left; font-size:14px; color:#888; margin-bottom:5px; margin-left:10px;">å§“å</div>
            <input id="regName" placeholder="ç‹å°æ˜" style="width:95%; margin:0 auto 15px auto; display:block;">
            
            <div style="text-align:left; font-size:14px; color:#888; margin-bottom:5px; margin-left:10px;">æ‰‹æ©Ÿ</div>
            <input id="regPhone" type="tel" placeholder="09xxxxxxxx" style="width:95%; margin:0 auto 15px auto; display:block;" maxlength="10">
            
            <div style="text-align:left; font-size:14px; color:#888; margin-bottom:5px; margin-left:10px;">ç”Ÿæ—¥</div>
            <input id="regBirthday" type="date" style="width:95%; margin:0 auto 15px auto; display:block;">
        `,
        confirmButtonText: 'ç¢ºå®šè¨»å†Š', confirmButtonColor: '#9CB071', showCancelButton: true, cancelButtonText: 'å–æ¶ˆ',
        preConfirm: () => {
          const n = document.getElementById('regName').value.trim();
          const p = document.getElementById('regPhone').value.trim();
          const b = document.getElementById('regBirthday').value; 
          if(!n || !p || !b) { Swal.showValidationMessage('è«‹å¡«å¯«å®Œæ•´ (åŒ…å«ç”Ÿæ—¥)'); return false; }
          if(!/^09\d{8}$/.test(p)) { Swal.showValidationMessage('æ‰‹æ©Ÿæ ¼å¼éŒ¯èª¤'); return false; }
          return {name: n, phone: p, birthday: b};
        }
      });

      if(res.isConfirmed) {
        showLoading();
        const currentPass = isAdminMode ? GLOBAL_PASS : null;
        const r = await callApi('registerMember', { password: currentPass, name: res.value.name, phone: res.value.phone, birthday: res.value.birthday });
        hideLoading();

        if(r.success) {
          Swal.fire('æˆåŠŸ', 'è¨»å†Šå®Œæˆï¼', 'success');
          if(isAdminMode) { 
            const adminRes = await callApi('adminLoginAndGetData', { password: GLOBAL_PASS });
            if(adminRes.success){ ALL_MEMBERS=adminRes.list; updateAdminUI(adminRes.list, adminRes.totalRedeemed); }
          }
        } else { Swal.fire('å¤±æ•—', r.msg, 'error'); }
      }
    }

    function logoutAdmin() { GLOBAL_PASS = ""; sessionStorage.removeItem('STAFF_PASS'); if(POLLING_TIMER) clearInterval(POLLING_TIMER); showView('view-home'); }
    
    window.onload = async function() {
      const urlParams = new URLSearchParams(window.location.search);
      const p = urlParams.get('phone');
      if(p) { document.getElementById('homePhone').value = p; userLogin(); }
      let savedPass = sessionStorage.getItem('STAFF_PASS');
      if(savedPass) {
        GLOBAL_PASS = savedPass; 
        showView('view-admin'); 
        renderAdminSkeleton();  
        
        startFunLoading();
        const r = await callApi('adminLoginAndGetData', { password: GLOBAL_PASS });
        stopFunLoading();
        
        if(r.success) { ALL_MEMBERS = r.list; GLOBAL_STAFF_NAME = r.staffName; updateAdminUI(r.list, r.totalRedeemed); startPolling(); } 
        else { sessionStorage.removeItem('STAFF_PASS'); showView('view-home'); }
      }
    }
  </script>
</body>
</html>