<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>ç„¡è²³è‰¯å“é›†é»å¡</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root{--y:#EFC050;--g:#9CB071;--p:#F7A8B8;--bg:#FAFAFA;--txt:#555}
body{font-family:'Noto Sans TC',sans-serif;background:var(--bg);margin:0;padding:20px;color:var(--txt);-webkit-tap-highlight-color:transparent}
.view{display:none;min-height:90vh;flex-direction:column;align-items:center;width:100%;max-width:500px;margin:0 auto}
.view.active{display:flex}
h2{margin:10px 0 5px;letter-spacing:2px;font-size:24px;font-weight:500;text-align:center}
.sub{color:#999;font-size:13px;margin-bottom:30px;letter-spacing:1px;font-weight:300;text-align:center}
input{width:100%;padding:15px;border:2px solid #eee;border-radius:25px;font-size:16px;text-align:center;margin-bottom:15px;background:#fff;transition:.3s;box-sizing:border-box;font-family:inherit}
input:focus{outline:0;border-color:var(--y);box-shadow:0 0 0 4px rgba(239,192,80,.1)}
button{width:100%;padding:15px;border:none;border-radius:25px;font-size:16px;font-weight:500;cursor:pointer;transition:.2s;margin-bottom:15px;font-family:inherit}
button:active{transform:scale(.98)}
.btn-y{background:var(--y);color:#fff;box-shadow:0 8px 20px -5px rgba(239,192,80,.4)}
.btn-g{background:var(--g);color:#fff;box-shadow:0 8px 20px -5px rgba(156,176,113,.4)}
.btn-p{background:var(--p);color:#fff;box-shadow:0 8px 20px -5px rgba(247,168,184,.4)}
.btn-o{background:#fff;border:1px solid #ddd;color:#888}
.btn-adm{background:#fff;color:var(--g);border:1px solid var(--g);font-size:14px;padding:12px}
.btn-reg{background:#fff;border:2px solid var(--y);color:var(--y)}
.card{background:#fff;padding:50px 30px;border-radius:30px;box-shadow:0 15px 35px -10px rgba(0,0,0,.08);width:100%;box-sizing:border-box;text-align:center}
.div{margin:25px 0;display:flex;align-items:center;justify-content:center;color:#ccc;font-size:12px}
.div::before,.div::after{content:'';flex:1;border-bottom:1px solid #eee;margin:0 10px}
.link{margin-top:10px;font-size:13px;color:#aaa;text-decoration:underline;cursor:pointer;display:block}
.u-card{background:#fff;width:100%;padding:30px 25px;border-radius:35px;box-shadow:0 20px 40px -10px rgba(0,0,0,.08);position:relative;overflow:hidden;box-sizing:border-box;margin-bottom:20px}
.u-card::before{content:'';position:absolute;top:0;left:0;right:0;height:6px;background:linear-gradient(to right,var(--p),var(--y),var(--g))}
.head{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px}
.grid{display:grid;grid-template-columns:repeat(5,1fr);gap:15px;justify-items:center}
.stp{width:40px;height:40px;border-radius:50%;background:#F5F5F5;display:flex;align-items:center;justify-content:center;font-size:14px;color:#CCC;transition:.3s}
.stp.on{background:var(--p);color:#fff;transform:scale(1.1);box-shadow:0 5px 15px rgba(247,168,184,.4)}
.stp.on.anim{animation:pop .5s ease}@keyframes pop{0%{transform:scale(.5);opacity:0}100%{transform:scale(1.1);opacity:1}}
.wall{background:#FFF8E1;border:2px dashed var(--y);border-radius:20px;padding:15px;margin-top:25px;text-align:center;display:none}
.wall-n{font-size:32px;font-weight:700;color:var(--y);margin:5px 0}
.btn-use{background:var(--y);color:#fff;font-size:14px;padding:8px 20px;border-radius:15px;width:auto;margin:0;box-shadow:0 4px 10px rgba(239,192,80,.3)}
.nav{display:flex;justify-content:space-between;align-items:center;width:100%;margin-bottom:15px}
.dash{display:grid;grid-template-columns:1fr 1fr;gap:10px;width:100%;margin-bottom:20px}
.stat{background:#fff;padding:15px;border-radius:20px;text-align:center;border-bottom:4px solid #eee}
.s-val{font-size:22px;font-weight:500;color:#333}.s-lbl{font-size:11px;color:#999}
.search{display:flex;gap:10px;margin-bottom:20px}.search input{margin:0;flex:1;text-align:left;padding-left:20px}
.m-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:15px;width:100%;padding-bottom:80px}
.mc{background:#fff;border-radius:20px;padding:15px;cursor:pointer;border:2px solid transparent;transition:.2s;position:relative}
.mc:active{transform:scale(.98)}.mc.has{border-color:var(--p);background:#FFFBFB}
.bar{height:6px;background:#eee;border-radius:3px;margin-top:10px;overflow:hidden}.fill{height:100%;background:var(--g);width:0%;transition:.3s}
.mc.has .fill{background:var(--p)}.c-bad{position:absolute;top:10px;right:10px;font-size:10px;background:var(--p);color:#fff;padding:2px 8px;border-radius:8px;display:none}
.mc.has .c-bad{display:block}.b-bad{position:absolute;top:10px;left:10px;font-size:16px;display:none}
.mc.bday .b-bad{display:block;animation:bnc 1s infinite}@keyframes bnc{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
.fab{position:fixed;bottom:30px;right:30px;width:55px;height:55px;background:var(--g);color:#fff;border-radius:50%;font-size:28px;display:flex;align-items:center;justify-content:center;box-shadow:0 10px 20px -5px rgba(156,176,113,.5);cursor:pointer;z-index:100}
.ctrl-in{background:#f9f9f9;padding:20px;border-radius:20px;margin-bottom:20px}
.num-d{font-size:48px;font-weight:700;color:var(--g);margin-bottom:10px;line-height:1}
.money-w{display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:15px}
.money-i{width:100px;padding:5px 10px;border:1px solid #ddd;border-radius:10px;font-size:14px;margin:0;text-align:center}
input[type=range]{-webkit-appearance:none;width:100%;background:0 0}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;height:24px;width:24px;border-radius:50%;background:#fff;border:2px solid var(--g);cursor:pointer;margin-top:-10px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
input[type=range]::-webkit-slider-runnable-track{width:100%;height:4px;cursor:pointer;background:#ddd;border-radius:2px}
.acts{display:flex;gap:10px}.btn-add{flex:2;background:var(--g);color:#fff;border-radius:15px;padding:12px;font-size:15px;border:none;box-shadow:0 4px 10px rgba(156,176,113,.3)}
.btn-sub{flex:1;background:#fff;color:#E57373;border:1px solid #E57373;border-radius:15px;padding:12px;font-size:15px}
.btn-bon{background:#FFF3E0;color:#FF9800;font-size:14px;padding:8px 15px;border-radius:20px;border:1px solid #FFE0B2;margin-bottom:10px;cursor:pointer;display:inline-block}.btn-bon.used{background:#EEE;color:#AAA;border-color:#DDD;cursor:default}
.skel{animation:sl 1.5s infinite;color:transparent!important;background:#f0f0f0;border-radius:8px}@keyframes sl{0%,100%{background-color:#f0f0f0}50%{background-color:#e0e0e0}}
.sk-t{width:100%;height:1em;display:inline-block}
div:where(.swal2-popup){border-radius:30px!important;padding:25px!important;width:85%!important;max-width:360px!important}
div:where(.swal2-actions) button{border-radius:15px!important;flex:1!important;margin:0 5px!important}
#load{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.98);z-index:9999;display:none;justify-content:center;align-items:center;flex-direction:column}
.spin{font-size:40px;display:inline-block;animation:sp 1.2s linear infinite}.spin:nth-child(2){animation-delay:.2s}.spin:nth-child(3){animation-delay:.4s}@keyframes sp{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
</style>
</head>
<body>
  <div id="load">
    <div style="display:flex;gap:10px;"><span class="spin">ğŸ‹</span><span class="spin">ğŸŒ¿</span><span class="spin">ğŸŒ¸</span></div>
    <div style="font-size:12px;color:#aaa;margin-top:15px;letter-spacing:2px;">PROCESSING...</div>
    <button onclick="stopLoad(true)" style="width:auto;margin-top:30px;padding:8px 25px;background:#fff;border:1px solid #ddd;border-radius:20px;color:#999;font-size:13px">âœ• å–æ¶ˆ</button>
  </div>

  <div id="v-home" class="view active">
    <div class="card">
      <h2 style="color:var(--g)">ç„¡è²³è‰¯å“</h2><div class="sub">é›†é»æœƒå“¡ç³»çµ±</div>
      <input type="tel" id="hp" placeholder="è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼" maxlength="10">
      <button class="btn-y" onclick="uLogin()">æŸ¥è©¢é›†é»å¡</button>
      <button class="btn-reg" onclick="reg()">ç«‹å³è¨»å†Šæœƒå“¡</button>
      <div class="link" onclick="rules()">ğŸ“ æŸ¥çœ‹é›†é»è¦å‰‡</div>
      <div class="div">STAFF ONLY</div>
      <button class="btn-adm" onclick="admLogin()">å·¥ä½œå¤¥ä¼´å…¥å£</button>
    </div>
  </div>

  <div id="v-user" class="view">
    <h2 style="margin-top:30px">æˆ‘çš„é›†é»å¡</h2><div class="sub">ç„¡è²³è‰¯å“</div>
    <div class="u-card">
      <div class="head">
        <div style="font-size:18px;font-weight:500">æœƒå“¡å¡</div>
        <div style="background:#f5f5f5;color:#999;padding:4px 12px;border-radius:15px;font-size:12px" id="un"></div>
      </div>
      <div class="grid" id="ug"></div>
      <div id="ufull" style="text-align:center;margin-top:20px;display:none">
        <div style="color:var(--p);font-weight:500;font-size:16px;margin-bottom:5px">ğŸ‰ å·²é›†æ»¿ 10 é»ï¼</div>
        <div style="color:var(--y);font-weight:700;font-size:18px;letter-spacing:1px;border:2px dashed var(--y);padding:10px;border-radius:15px;background:#fffdf5">ç²å¾— 9 æŠ˜å…Œæ›åˆ¸</div>
      </div>
      <div id="uwall" class="wall">
        <div style="font-size:13px;color:#888">âœ¨ å¯ç”¨å„ªæƒ åˆ¸ (å¯ç´¯ç©)</div>
        <div class="wall-n"><span id="ucnt">0</span> å¼µ</div>
        <button class="btn-use" onclick="uRedeem()">ç«‹å³å…Œæ›æŠ˜æ‰£</button>
      </div>
      <div style="text-align:center;margin-top:30px;font-size:13px;color:#999">
        æ­·å²ä½¿ç”¨ï¼š<span id="ur" style="color:var(--y);font-weight:500;font-size:16px;cursor:pointer;text-decoration:underline" onclick="hist(STATE.curr)">0</span> å¼µ
      </div>
    </div>
    <div class="link" onclick="rules()" style="text-align:center;margin-bottom:20px">ğŸ“ æŸ¥çœ‹é›†é»è¦å‰‡</div>
    <button class="btn-o" onclick="route('v-home')">â†º è¿”å›æŸ¥è©¢</button>
  </div>

  <div id="v-adm" class="view">
    <div class="nav">
      <div style="font-weight:500;display:flex;align-items:center;gap:5px">ç„¡è²³å¾Œå° <span id="sn" style="font-size:12px;background:#E8F5E9;color:#4CAF50;padding:2px 8px;border-radius:10px">Guest</span></div>
      <button class="btn-o" style="width:auto;margin:0;padding:5px 15px;font-size:12px;border-radius:15px" onclick="logout()">ç™»å‡º</button>
    </div>
    <div class="dash">
      <div class="stat" style="border-color:var(--p)"><div class="s-lbl">å„ªæƒ åˆ¸å·²å…Œæ›</div><div class="s-val" id="ar">0</div></div>
      <div class="stat" style="border-color:var(--y)"><div class="s-lbl">æœƒå“¡ç¸½æ•¸</div><div class="s-val" id="am">0</div></div>
    </div>
    <div class="search"><input type="text" id="as" placeholder="ğŸ” æœå°‹..." onkeyup="filter()"></div>
    <div class="m-grid" id="ag"></div>
    <div class="fab" onclick="reg()">ï¼‹</div>
  </div>

<script>
// â˜…â˜…â˜… GAS API URL â˜…â˜…â˜…
const API_URL = "https://script.google.com/macros/s/AKfycbwsfPMn54aqd3u-4SHkGmdfS-drw8MLNE-3lVq1XP-pCPSOW1ZxwDvTnd-85uQpuuc/exec";

const $ = s => document.querySelector(s);
const STATE = { pass: '', staff: '', mems: [], curr: '', timer: null };
const AUD = { s: new Audio('https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg'), r: new Audio('https://actions.google.com/sounds/v1/science_fiction/scifi_laser.ogg'), e: new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg') };
const play = t => { try{ let a=AUD[t]; a.currentTime=0; a.play(); }catch(e){} };
const toast = (ic, ti) => Swal.fire({toast:true,position:'top',icon:ic,title:ti,showConfirmButton:false,timer:1500});

async function api(act, p={}) {
  try { return await (await fetch(API_URL, {method:"POST", body:JSON.stringify({action:act, params:p})})).json(); }
  catch(e) { return {success:false, msg:"é€£ç·šéŒ¯èª¤"}; }
}

let loadT = null;
const msgs = ["è³‡æ–™è®€å–ä¸­...","è«‹ç¨å€™...","é€£ç·šä¸­..."];
function load(s=true) {
  $('#load').style.display = s ? 'flex' : 'none';
  if(s) { let i=0; if(loadT) clearInterval(loadT); loadT=setInterval(()=>{$('#load div:nth-child(2)').innerText=msgs[i++%3]}, 1500); }
  else if(loadT) clearInterval(loadT);
}
function stopLoad(force) { if(STATE.timer) clearInterval(STATE.timer); if(force){ STATE.pass=""; load(false); route('v-home'); } }

function route(id) { document.querySelectorAll('.view').forEach(e=>e.classList.remove('active')); $(`#${id}`).classList.add('active'); window.scrollTo(0,0); }

function rules() { Swal.fire({title:'è¦å‰‡èªªæ˜',html:`<div style="text-align:left;font-size:14px;color:#555">1. æ¶ˆè²» $100 é›† 1 é»<br>2. é›†æ»¿ 10 é»æ› 9 æŠ˜åˆ¸<br>3. é¦–æ¬¡æ¶ˆè²»è´ˆ 5 é»</div>`,confirmButtonColor:'#EFC050'}); }

// User Logic
async function uLogin() {
  const p = $('#hp').value.trim();
  if(!p) return Swal.fire('è«‹è¼¸å…¥æ‰‹æ©Ÿ');
  STATE.curr = p; route('v-user');
  $('#un').innerHTML = '<span class="skel sk-t" style="width:80px"></span>';
  $('#ug').innerHTML = Array(10).fill('<div class="stp skel"></div>').join('');
  
  load(); const r = await api('getMemberData', {phone:p}); load(false);
  if(r.success) {
    if(r.isBirthdayToday) { confetti({origin:{y:.7}}); Swal.fire({title:'ğŸ‚ ç”Ÿæ—¥å¿«æ¨‚ï¼',icon:'success',timer:2000,showConfirmButton:false}); }
    renderU(r.name, r.current, r.redeemed);
  } else {
    Swal.fire({icon:'error',title:'æŸ¥ç„¡æœƒå“¡',confirmButtonText:'å»è¨»å†Š',confirmButtonColor:'#EFC050'}).then(res=>{if(res.isConfirmed)reg(); else route('v-home')});
  }
}

function renderU(n, cur, red) {
  $('#un').innerText = n; $('#ur').innerText = red; $('#ucnt').innerText = Math.floor(cur/10);
  const prog = cur % 10;
  $('#ug').innerHTML = Array.from({length:10},(_,i)=>`<div class="stp ${i<prog?'on anim':''}" style="animation-delay:${(i+1)*.05}s">${i+1}</div>`).join('');
  $('#ufull').style.display = prog>=10?'block':'none';
  $('#uwall').style.display = Math.floor(cur/10)>0?'block':'none';
}

async function uRedeem() {
  const {value:pass} = await Swal.fire({title:'åº—å“¡ç¢ºèª',text:'è«‹è¼¸å…¥åº—å“¡å¯†ç¢¼',input:'password',showCancelButton:true,confirmButtonColor:'#9CB071'});
  if(pass) {
    load(); const r = await api('redeemCard', {password:pass, phone:STATE.curr}); load(false);
    if(r.success) { play('r'); Swal.fire('å…Œæ›æˆåŠŸ','','success'); renderU($('#un').innerText, r.current, r.redeemed); }
    else { play('e'); Swal.fire('å¤±æ•—', r.msg, 'error'); }
  }
}

// Admin Logic
async function admLogin() {
  const {value:pass} = await Swal.fire({title:'å¾Œå°ç™»å…¥',input:'password',confirmButtonColor:'#9CB071'});
  if(pass) {
    STATE.pass = pass; route('v-adm');
    $('#ag').innerHTML = Array(6).fill('<div class="mc skel" style="height:100px"></div>').join('');
    load(); const r = await api('adminLoginAndGetData',{password:pass}); load(false);
    if(r.success) {
      sessionStorage.setItem('SP', pass); STATE.mems = r.list; STATE.staff = r.staffName;
      updAdm(r.list, r.totalRedeemed); poll();
    } else { route('v-home'); Swal.fire('éŒ¯èª¤', r.msg, 'error'); }
  }
}

function updAdm(list, tr) {
  $('#sn').innerText = STATE.staff; $('#ar').innerText = tr; $('#am').innerText = list.length;
  filter();
}

function renderG(list) {
  $('#ag').innerHTML = list.map(m => {
    const full = Math.floor(m.current/10), p = (m.current%10)*10;
    return `<div class="mc ${full>0?'has':''} ${m.isBirthdayToday?'bday':''}" onclick="act('${m.phone}')">
      <div class="b-bad">ğŸ‚</div><div class="c-bad">åˆ¸ ${full}</div>
      <div style="font-weight:500">${m.name}</div><div style="font-size:12px;color:#999;margin-bottom:5px">${m.phone}</div>
      <div style="font-size:12px;color:#aaa">é€²åº¦ ${m.current%10}/10</div>
      <div class="bar"><div class="fill" style="width:${p}%"></div></div>
    </div>`;
  }).join('');
}

function filter() { const k = $('#as').value.toLowerCase(); renderG(STATE.mems.filter(m=>m.name.includes(k)||m.phone.includes(k))); }

function poll() {
  if(STATE.timer) clearInterval(STATE.timer);
  STATE.timer = setInterval(async()=>{
    if($('#v-adm').classList.contains('active') && STATE.pass) {
      const r = await api('adminLoginAndGetData',{password:STATE.pass});
      if(r.success){ STATE.mems = r.list; updAdm(r.list, r.totalRedeemed); }
    }
  }, 20000);
}

// Admin Actions
function act(ph) {
  const m = STATE.mems.find(x=>x.phone==ph);
  if(!m) return;
  if(m.isBirthdayToday) { confetti({origin:{y:.7}}); toast('success', `${m.name} ç”Ÿæ—¥å¿«æ¨‚!`); }
  const full = Math.floor(m.current/10);
  
  Swal.fire({
    title:'', showConfirmButton:false,
    html: `
      <div class="ctrl-in">
        <div style="font-size:22px;font-weight:700;color:#333;margin-bottom:5px">${m.name}${m.isBirthdayToday?' ğŸ‚':''}</div>
        <div style="font-size:13px;color:#888;margin-bottom:15px">ç›®å‰ ${m.current} é» (åˆ¸ ${full})</div>
        <div class="btn-bon ${m.isFirstUsed?'used':''}" onclick="bonus('${ph}',${m.isFirstUsed})">${m.isFirstUsed?'ğŸ”’ å·²é ˜é¦–è³¼ç¦®':'ğŸ ç™¼é€é¦–è³¼ç¦® (+5)'}</div>
        <div class="num-d" id="nd">1</div>
        <div class="money-w"><span>$</span><input type="number" class="money-i" placeholder="é‡‘é¡" oninput="calc(this.value)"><span>= é»</span></div>
        <input type="range" id="rng" min="0" max="100" value="1" oninput="sync(this.value)">
      </div>
      <div class="acts">
        <button class="btn-sub" onclick="stamp('${ph}',-1)">æ‰£é™¤</button>
        <button class="btn-add" onclick="stamp('${ph}',1)">åŠ é»</button>
      </div>
      ${full>0 ? `<button class="btn-p" style="margin-top:15px;display:flex;justify-content:space-between;padding:12px 20px" onclick="admRedeem('${ph}')"><span>ğŸ« å…Œæ›åˆ¸</span><span>é¤˜ ${full}</span></button>`:''}
      <div class="link" onclick="hist('${ph}')">æŸ¥çœ‹ç´€éŒ„ ></div>
    `
  });
}

window.calc = v => sync(v ? Math.floor(v/100) : 0);
window.sync = v => { const r=$('#rng'); if(Number(v)>Number(r.max)) r.max=Number(v)+10; $('#nd').innerText=v; r.value=v; };

async function stamp(ph, mul) {
  const val = Number($('#nd').innerText), money = $('.money-i').value;
  load(); const r = await api('addStamp', {password:STATE.pass, phone:ph, amount:val*mul, money}); load(false);
  if(r.success) {
    play('s'); updLocal(ph, r.current, r.redeemed);
    act(ph); toast('success', `æˆåŠŸ${mul>0?'å¢åŠ ':'æ‰£é™¤'} ${val} é»`);
  } else { play('e'); Swal.fire('å¤±æ•—', r.msg, 'error'); }
}

async function admRedeem(ph) {
  Swal.close();
  const res = await Swal.fire({title:'ç¢ºèªå…Œæ›ï¼Ÿ',text:'æ‰£é™¤ 10 é»',icon:'warning',showCancelButton:true,confirmButtonText:'ç¢ºèª',confirmButtonColor:'#d33'});
  if(res.isConfirmed) {
    load(); const r = await api('redeemCard', {password:STATE.pass, phone:ph}); load(false);
    if(r.success) { play('r'); updLocal(ph, r.current, r.redeemed); act(ph); toast('success','å…Œæ›æˆåŠŸ'); }
    else { play('e'); Swal.fire('å¤±æ•—', r.msg, 'error'); }
  } else act(ph);
}

async function bonus(ph, used) {
  if(used) {
    const {value:p} = await Swal.fire({title:'å·²é ˜é',text:'å¼·åˆ¶è£œç™¼éœ€ç®¡ç†å“¡å¯†ç¢¼',input:'password',showCancelButton:true,confirmButtonColor:'#d33'});
    if(!p) return; STATE.pass = p; 
  }
  load(); const r = await api('giveFirstBonus', {password:STATE.pass, phone:ph, forceOverride:used}); load(false);
  if(r.success) { play('s'); updLocal(ph, r.current, r.redeemed, true); act(ph); toast('success', 'å·²ç™¼é€é¦–è³¼ç¦®'); }
  else { play('e'); Swal.fire('å¤±æ•—', r.msg, 'error'); }
}

function updLocal(ph, c, r, f=null) {
  const m = STATE.mems.find(x=>x.phone==ph);
  if(m) { m.current=c; m.redeemed=r; if(f!==null) m.isFirstUsed=f; updAdm(STATE.mems, $('#ar').innerText); }
}

async function hist(ph) {
  load(); const r = await api('getMemberHistory', {phone:ph}); load(false);
  if(!r.success) return Swal.fire('è®€å–å¤±æ•—');
  const h = r.history.length ? r.history.map(x=>`
    <div style="padding:12px 5px;border-bottom:1px solid #f5f5f5;display:flex;justify-content:space-between;align-items:center">
      <div><div style="font-size:14px;font-weight:500;color:${x.action.match(/åŠ |è´ˆ|è²»/)?'var(--g)':x.action.match(/æ‰£|å…Œ/)?'var(--p)':'#333'}">${x.money?`$${x.money} `:''}${x.action}</div><div style="font-size:11px;color:#aaa">${x.date}</div></div>
      <div style="font-size:11px;background:#f0f0f0;padding:2px 8px;border-radius:8px;color:#888">${x.staff}</div>
    </div>`).join('') : '<div style="color:#ccc;padding:20px;text-align:center">ç„¡ç´€éŒ„</div>';
  Swal.fire({title:'',html:`<div><div style="font-size:18px;font-weight:700;margin-bottom:15px">ğŸ“œ æ­·å²ç´€éŒ„</div><div style="max-height:300px;overflow-y:auto;text-align:left;border-top:1px solid #eee">${h}</div></div>`,confirmButtonColor:'#EFC050',confirmButtonText:'é—œé–‰'});
}

async function reg() {
  const isAdm = $('#v-adm').classList.contains('active');
  const {value:v} = await Swal.fire({
    title:'æ–°æœƒå“¡è¨»å†Š',
    html:`<input id="rn" placeholder="å§“å"><input id="rp" type="tel" placeholder="æ‰‹æ©Ÿ" maxlength="10"><input id="rb" type="date">`,
    confirmButtonText:'è¨»å†Š', showCancelButton:true, confirmButtonColor:'#9CB071',
    preConfirm:()=>{
      const n=$('#rn').value, p=$('#rp').value, b=$('#rb').value;
      return (!n||!p||!b||!/^09\d{8}$/.test(p)) ? Swal.showValidationMessage('è³‡æ–™ä¸å®Œæ•´æˆ–æ ¼å¼éŒ¯èª¤') : {name:n, phone:p, birthday:b};
    }
  });
  if(v) {
    load(); const r = await api('registerMember', {password:isAdm?STATE.pass:null, ...v}); load(false);
    if(r.success) { Swal.fire('æˆåŠŸ','','success'); if(isAdm) { const ar=await api('adminLoginAndGetData',{password:STATE.pass}); if(ar.success){STATE.mems=ar.list; updAdm(ar.list, ar.totalRedeemed);} } }
    else Swal.fire('å¤±æ•—', r.msg, 'error');
  }
}

function logout() { STATE.pass=""; sessionStorage.removeItem('SP'); stopLoad(); route('v-home'); }

window.onload = async () => {
  const p = new URLSearchParams(location.search).get('phone');
  if(p) { $('#hp').value=p; uLogin(); }
  const sp = sessionStorage.getItem('SP');
  if(sp) {
    STATE.pass=sp; route('v-adm'); $('#ag').innerHTML=Array(6).fill('<div class="mc skel" style="height:100px"></div>').join('');
    load(); const r=await api('adminLoginAndGetData',{password:sp}); load(false);
    if(r.success){ STATE.mems=r.list; STATE.staff=r.staffName; updAdm(r.list, r.totalRedeemed); poll(); } else { logout(); }
  }
};
</script>
</body>
</html>